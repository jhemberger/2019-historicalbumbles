---
title: "Ch4 | Historical Ag & Bumble Bee Abundance/Community Changes"
subtitle: "Species GLMs"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_notebook
---

**Name:** Jeremy Hemberger
**Email:** j.hemberger.wisc@gmail.com
**Institution:** University of Wisconsin - Madison | Department of Entomology

# Import packages
```{r} 
library(tidyverse)
library(broom)
library(broom.mixed)
library(rgdal)
library(ggmap)
library(ggalt)
library(ggforce)
library(cowplot)
library(raster)
library(maptools)
library(maps)
library(mapdata)
library(mp)
library(vegan)
library(iNEXT)
library(magrittr)
library(openintro)
library(lme4)
library(lmerTest)
library(coin)
library(rbin)
library(directlabels)
library(spdep)
library(spatialreg)
library(spdplyr)
library(jtools)
library(effects)
```

# IMPORT DATA
```{r}
spatial.bumbles.df <- read_csv("./spatial_bumbles.csv") %>%
  dplyr::select(date, year, species, subgenus, dec_lat, dec_long, state, county, region, decade, t_period, time_period, 
                bin_3, bin_5, bin_8, collector_spp_date)
midwestag.vars.df <- read_csv("./midwestag_vars.csv")
midwestag.othervars.df <- read_csv("./agvars_other.csv",
                                   col_types = list(col_double(),
                                                    col_character(),
                                                    col_character(),
                                                    col_double(),
                                                    col_double(),
                                                    col_double(),
                                                    col_double(),
                                                    col_double(),
                                                    col_double(),
                                                    col_double(),
                                                    col_double(),
                                                    col_double()))
```

# MATCH AG/BUMBLE RECORDS
## Append additional ag variables
```{r}
midwestag.othervars.df <- midwestag.othervars.df %>%
  mutate(state_name = state2abbr(state_name))
midwestag.model.df <- midwestag.vars.df %>%
  left_join(midwestag.othervars.df,
            by = c("state" = "state_name",
                   "year" = "year",
                   "county" = "county_name"))

```

## Create time bin for each ag census period & common vs. rare category
```{r}
spatial.bumbles.df <- spatial.bumbles.df %>%
  mutate(bin_ag = case_when(
    year <= 1845 ~ 1840,
    between(year, 1846, 1855) ~ 1850,
    between(year, 1856, 1865) ~ 1860,
    between(year, 1866, 1875) ~ 1870,
    between(year, 1876, 1885) ~ 1880,
    between(year, 1886, 1895) ~ 1890,
    between(year, 1896, 1905) ~ 1900,
    between(year, 1906, 1915) ~ 1910,
    between(year, 1916, 1925) ~ 1920,
    between(year, 1926, 1935) ~ 1930,
    between(year, 1936, 1945) ~ 1940,
    between(year, 1946, 1955) ~ 1950,
    between(year, 1956, 1965) ~ 1959,
    between(year, 1966, 1975) ~ 1974,
    between(year, 1976, 1985) ~ 1982,
    between(year, 1986, 1995) ~ 1992, 
    between(year, 1996, 2005) ~ 2002,
    between(year, 2006, 2019) ~ 2012),
    cmn.rare = if_else(species %in% c("Bombus impatiens",
                                      "Bombus bimaculatus",
                                      "Bombus griseocollis",
                                      "Bombus vagans",
                                      "Bombus ternarius",
                                      "Bombus auricomus"),
                       "common",
                       if_else(species %in% c("Bombus terricola",
                                              "Bombus affinis",
                                              "Bombus pensylvanicus"),
                               "rare",
                               "uncommon")))
spatial.bumbles.df
  
```

## Create `spatial.bumbles.df` matching exact year +/- 3 only and append ag data (per JO suggestion)
```{r}
spatial.bumbles.2yr.df <- read_csv("./spatial_bumbles.csv") %>%
  dplyr::select(date, year, species, subgenus, dec_lat, dec_long, state, county, region, decade, t_period, time_period, 
                bin_3, bin_5, bin_8, collector_spp_date)

spatial.bumbles.2yr.df <- spatial.bumbles.2yr.df %>%
  mutate(bin_ag = case_when(
    between(year, 1847, 1853) ~ 1850,
    between(year, 1857, 1963) ~ 1860,
    between(year, 1867, 1873) ~ 1870,
    between(year, 1877, 1883) ~ 1880,
    between(year, 1887, 1893) ~ 1890,
    between(year, 1897, 1903) ~ 1900,
    between(year, 1907, 1913) ~ 1910,
    between(year, 1917, 1923) ~ 1920,
    between(year, 1927, 1933) ~ 1930,
    between(year, 1937, 1943) ~ 1940,
    between(year, 1947, 1953) ~ 1950,
    between(year, 1957, 1963) ~ 1959,
    between(year, 1972, 1977) ~ 1974,
    between(year, 1979, 1985) ~ 1982,
    between(year, 1989, 1995) ~ 1992,
    between(year, 1999, 2005) ~ 2002,
    between(year, 2009, 2015) ~ 2012)) %>%
  filter(!is.na(bin_ag))
spatial.bumbles.2yr.df

spatial.bumbles.2yr.ra.df <- spatial.bumbles.2yr.df %>%
  group_by(species, subgenus, state, county, bin_ag) %>%
  summarise(species_abun = n()) %>%
  ungroup() %>%
  left_join(spatial.bumbles.2yr.df %>%
              group_by(state, county, bin_ag) %>%
              summarise(bin_ag_abundance = n()),
            by = c("bin_ag" = "bin_ag",
                   "state" = "state",
                   "county" = "county")) %>%
  mutate(rel_abun = species_abun / bin_ag_abundance)
spatial.bumbles.2yr.ra.df

spatial.bumbles.glmvars.2yr.df <- spatial.bumbles.2yr.ra.df %>%
  ungroup() %>%
  left_join(midwestag.model.df,
            by = c("bin_ag" = "year",
                   "state" = "state",
                   "county" = "county")) %>%
  filter(bin_ag_abundance > 5) # tuner for minimum number of records per county
spatial.bumbles.glmvars.2yr.df
```

## Summarize data by `ag_bin` 
(Relative abundance of species in each county at each ag census time point)
```{r}
spatial.bumbles.ra.df <- spatial.bumbles.df %>%
  group_by(species, subgenus, state, county, bin_ag) %>%
  summarise(species_abun = n()) %>%
  ungroup() %>%
  left_join(spatial.bumbles.df %>%
              group_by(state, county, bin_ag) %>%
              summarise(bin_ag_abundance = n()),
            by = c("bin_ag" = "bin_ag",
                   "state" = "state",
                   "county" = "county")) %>%
  mutate(rel_abun = species_abun / bin_ag_abundance)
spatial.bumbles.ra.df
```

## Join ag census data
```{r}
spatial.bumbles.glmvars.df <- spatial.bumbles.ra.df %>%
  ungroup() %>%
  left_join(midwestag.model.df,
            by = c("bin_ag" = "year",
                   "state" = "state",
                   "county" = "county")) %>%
  filter(bin_ag_abundance > 5) # tuner for minimum number of records per county
spatial.bumbles.glmvars.df
```

## Summarize data by `bin_ag`
### OPTION: Limit data to unique collector x time x location x species obsv
```{r}
spatial.bumbles.red.df <- spatial.bumbles.df %>%
  distinct(collector_spp_date,
           .keep_all = TRUE) 

spatial.bumbles.ra.red.df <- spatial.bumbles.red.df %>%
  group_by(species, subgenus, state, county, bin_ag) %>%
  summarise(species_abun = n()) %>%
  ungroup() %>%
  left_join(spatial.bumbles.df %>%
              group_by(state, county, bin_ag) %>%
              summarise(bin_ag_abundance = n()),
            by = c("bin_ag" = "bin_ag",
                   "state" = "state",
                   "county" = "county")) %>%
  mutate(rel_abun = species_abun / bin_ag_abundance)

spatial.bumbles.glmvars.red.df <- spatial.bumbles.ra.red.df %>%
  ungroup() %>%
  left_join(midwestag.model.df,
            by = c("bin_ag" = "year",
                   "state" = "state",
                   "county" = "county")) %>%
  filter(bin_ag_abundance > 5) # tuner for minimum number of records per county
spatial.bumbles.glmvars.red.df
```

### OPTION: remove 2012 of `bin_ag` to see if patterns of decline change
```{r}
spatial.bumbles.glmvars.no12.df <- spatial.bumbles.ra.df %>%
  ungroup() %>%
  filter(bin_ag < 2012) %>%
  left_join(midwestag.model.df,
            by = c("bin_ag" = "year",
                   "state" = "state",
                   "county" = "county")) %>%
  filter(bin_ag_abundance > 5) # tuner for minimum number of records per county
spatial.bumbles.glmvars.no12.df
```

# MODEL PROP. ABUNDANCE
## GLM function
```{r}
species.glms <- function(data) {
  species.list <- as.list(unique(data$species))
  glm.list <- list()
  df.list <- list()
  trend.plots.list <- list()
  propag.plots.list <- list()
  ncrops.plots.list <- list()
  for (i in species.list) {
    model.df <- data %>%
      filter(species == i) %>%
      filter(!is.na(species)) %>%
      filter(!is.na(prop_cropland))
    # print(model.df)
    glm.model <- glm(rel_abun ~
                       n_crops + 
                       prop_cropland +
                       # avgfarm + 
                       # cloverac + 
                       # pastureac + 
                       bin_ag,
                     data = model.df,
                     weights = model.df$bin_ag_abundance,
                     na.action = na.exclude,
                     family = binomial(link = "logit"))
    glm.df <- tidy(glm.model) %>%
      mutate(n_records = nrow(glm.model$model)) %>%
      dplyr::select(term, 
                    n_records, 
                    everything())
    # glmqq.plot <- qqPlot(residuals(glm.model))
    # resid.plot <- plot(glm.model)
    glm.list[[i]] <- glm.model
    df.list[[i]] <- glm.df
    
    predict <- predictorEffects(glm.model,
                                axes = list(x = list(rug = TRUE)),
                                se = list(compute = TRUE))
    predict.df <- bind_rows(as.tibble(predict$n_crops) %>%
                              rename(new_x = n_crops) %>%
                              mutate(var = "n_crops"), 
                            as.tibble(predict$prop_cropland) %>%
                              rename(new_x = prop_cropland) %>%
                              mutate(var = "prop_cropland"),
                            as.tibble(predict$bin_ag) %>%
                              rename(new_x = bin_ag) %>%
                              mutate(var = "bin_ag"))
    trend.plot <- ggplot() + 
      geom_point(data = model.df ,
                 mapping = aes(x = bin_ag,
                               y = rel_abun),
                 shape = 21,
                 fill = "black",
                 color = "black",
                 alpha = 1,
                 position = position_jitter(width = 1.5)) + 
      geom_ribbon(data = predict.df %>%
                    filter(var == "bin_ag"),
                  mapping = aes(x = new_x,
                                ymin = lower,
                                ymax = upper),
                  fill = "#F22B29",
                  color = "black",
                  alpha = 1) +
      geom_line(data = predict.df %>%
                  filter(var == "bin_ag"),
                mapping = aes(x = new_x,
                              y = fit),
                size = 1.25,
                color = "#F22B29") + 
      geom_rug(data = spatial.bumbles.df %>%
                 filter(species == i) %>%
                 mutate(rel_abun = 0),
               mapping = aes(x = year,
                             y = rel_abun),
               sides = "b",
               position = "jitter") + 
      theme_minimal_grid() + 
      scale_x_continuous(limits = c(1870, 2020),
                         breaks = seq(1870, 2020, by = 20)) +
      scale_y_continuous(limits = c(0, 1),
                         breaks = c(0, 0.5, 1)) +
      ylab(label = "Proportional Abundance") + 
      xlab(label = "Year") + 
      labs(title = paste(i,
                         "proportional abundance 1870-present",
                         sep = " "))
      ggsave(plot = trend.plot,
             filename = paste("./model_plots/trends/",
                              i,
                              ".eps",
                              sep = ""),
             height = 3,
             width = 5)
    
    propag.plot <- ggplot() + 
      geom_point(data = model.df ,
                 mapping = aes(x = prop_cropland,
                               y = rel_abun),
                 shape = 21,
                 fill = "black",
                 color = "black",
                 alpha = 1,
                 position = position_jitter()) + 
      geom_ribbon(data = predict.df %>%
                    filter(var == "prop_cropland"),
                  mapping = aes(x = new_x,
                                ymin = lower,
                                ymax = upper),
                  fill = "#F49D37",
                  color = "black",
                  alpha = 1) +
      geom_line(data = predict.df %>%
                  filter(var == "prop_cropland"),
                mapping = aes(x = new_x,
                              y = fit),
                size = 1.25,
                color = "#F49D37") + 
      theme_minimal_grid() + 
      # scale_x_continuous(limits = c(1870, 2020),
      #                    breaks = seq(1870, 2020, by = 20)) +
      ylab(label = "Proportional Abundance") + 
      xlab(label = "Proportion of county in agriculture") + 
      labs(title = i)
      ggsave(plot = propag.plot,
             filename = paste("./model_plots/pcropland/",
                              i,
                              ".eps",
                              sep = ""),
             height = 3,
             width = 5)
    
    ncrop.plot <- ggplot() + 
      geom_point(data = model.df ,
                 mapping = aes(x = n_crops,
                               y = rel_abun),
                 shape = 21,
                 fill = "black",
                 color = "black",
                 alpha = 1,
                 position = position_jitter()) + 
      geom_ribbon(data = predict.df %>%
                    filter(var == "n_crops"),
                  mapping = aes(x = new_x,
                                ymin = lower,
                                ymax = upper),
                  fill = "#140F2D",
                  color = "black",
                  alpha = 1) +
      geom_line(data = predict.df %>%
                  filter(var == "n_crops"),
                mapping = aes(x = new_x,
                              y = fit),
                size = 1.25,
                color = "#140F2D") + 
      theme_minimal_grid() + 
      # scale_x_continuous(limits = c(1870, 2020),
      #                    breaks = seq(1870, 2020, by = 20)) +
      ylab(label = "Proportional Abundance") + 
      xlab(label = "Number of crops grown") + 
      labs(title = i)
      ggsave(plot = ncrop.plot,
             filename = paste("./model_plots/ncrops/",
                              i,
                              ".eps",
                              sep = ""),
             height = 3,
             width = 5)
    print(trend.plot)
    print(propag.plot)
    print(ncrop.plot)
    trend.plots.list[[i]] <- trend.plot
    propag.plots.list[[i]] <- propag.plot
    ncrops.plots.list[[i]] <- ncrop.plot
  }
  assign("glm.output.list",
         glm.list,
         envir = .GlobalEnv)
  assign("glm.df.list",
         df.list,
         envir = .GlobalEnv)
  assign("glm.trendplots.list",
         trend.plots.list,
         envir = .GlobalEnv)
}
```


## Run GLM function
```{r}
species.glms(data = spatial.bumbles.glmvars.df)
species.glms(data = spatial.bumbles.glmvars.red.df) # reduced dataset
species.glms(data = spatial.bumbles.glmvars.no12.df) # reduced dataset 2
species.glms(data = spatial.bumbles.glmvars.2yr.df) # +/- 3 yr of ag data only

glms.df <- bind_rows(glm.df.list,
                     .id = "species")
glms.df <- glms.df %>%
  mutate(p.value = ifelse(p.value < 0.001,
                          "< 0.001",
                          round(p.value,
                                digits = 3)),
         estimate = round(estimate,
                          digits = 3),
         std.error = round(std.error,
                           digits = 4)) %>%
  write_csv("./model_output/sppglm.csv")
glms.df
```

## Plot GLM coefficients
### Use `ggplot`
#### Combine data (using scaled coefs)
```{r}
test <- summ(glm.output.list[[1]], scale = TRUE, confint = TRUE)
scale_coefs <- function(model.list) {
  df.list <- list()
  iter <- 0
  for (i in model.list) {
    iter <- iter + 1
    summ.glm <- summ(i,
                     scale = TRUE,
                     confint = TRUE)
    glm.df <- as.data.frame(summ.glm[["coeftable"]]) %>%
      mutate(term = c("(Intercept)",
                      "n_crops",
                      "prop_cropland",
                      "bin_ag")) %>%
      dplyr::select("term" = "term",
                    "estimate" = "Est.",
                    "lower.ci" = "2.5%",
                    "upper.ci" = "97.5%",
                    "z.stat" = "z val.",
                    "p.value" = "p") %>%
      mutate(species = names(model.list[iter]),
             sample.size = length(summ.glm$model$y)) %>%
      select(species, sample.size, everything())
    print(glm.df)
    df.list[[iter]] <- glm.df
  }
  glms.df <- bind_rows(df.list)
  assign("glms.df",
         glms.df,
         envir = .GlobalEnv)
}

scale_coefs(glm.output.list)
glms.df %>%
  mutate(p.value = ifelse(p.value < 0.001,
                          "< 0.001",
                          round(p.value,
                                digits = 3)),
         estimate = round(estimate,
                          digits = 3),
         lower.ci = round(lower.ci,
                           digits = 4),
         upper.ci = round(upper.ci,
                           digits = 4)) %>%
    write_csv("./model_output/sppglm.csv")
```

##### prop_agriculture
```{r}
coef.propag.plot <- glms.df %>%
  filter(sample.size > 60) %>%
  filter(term == "prop_cropland") %>%
  arrange(desc(estimate)) %>%
  mutate(row_order = factor(species,
                            levels = species)) %>%
  ggplot() + 
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "gray60",
             size = 0.6) + 
  geom_pointrange(mapping = aes(x = row_order,
                                y = estimate,
                                ymin = lower.ci,
                                ymax = upper.ci),
                  color = "black",
                  size = 0.6) + 
  geom_point(mapping = aes(x = row_order, 
                           y = estimate),
             shape = 21,
             size = 5,
             stroke = 1,
             fill = "black") + 
  scale_y_continuous(limits = c(-2.5, 1),
                     breaks = seq(-2.5,
                                  1,
                                  by = 0.5)) +
  theme_minimal() +
  coord_flip()
coef.propag.plot
ggsave("./model_plots/coefs/prop_cropland.eps",
       coef.propag.plot,
       width = 4,
       height = 4)
```

##### n_crops
```{r}
coef.ncrop.plot <- glms.df %>%
  filter(sample.size > 60) %>%
  filter(term == "n_crops") %>%
  arrange(desc(estimate)) %>%
  mutate(row_order = factor(species,
                            levels = species)) %>%
  ggplot() + 
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "gray60",
             size = 0.6) + 
  geom_pointrange(mapping = aes(x = row_order,
                                y = estimate,
                                ymin = lower.ci,
                                ymax = upper.ci),
                  color = "black",
                  size = 0.6) + 
  geom_point(mapping = aes(x = row_order, 
                           y = estimate),
             shape = 21,
             size = 5,
             stroke = 1,
             fill = "black") + 
  scale_y_continuous(limits = c(-1, 1),
                     breaks = seq(-1,
                                  1,
                                  by = 0.5)) +
  theme_minimal() +
  coord_flip()
coef.ncrop.plot
ggsave("./model_plots/coefs/n_crops.eps",
       coef.ncrop.plot,
       width = 4,
       height = 4)

```

##### year
```{r}
coef.year.plot <- glms.df %>%
  filter(sample.size > 60) %>%
  filter(term == "bin_ag") %>%
  arrange(desc(estimate)) %>%
  mutate(row_order = factor(species,
                            levels = species)) %>%
  ggplot() + 
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "gray60",
             size = 0.6) + 
  geom_pointrange(mapping = aes(x = row_order,
                                y = estimate,
                                ymin = lower.ci,
                                ymax = upper.ci),
                  color = "black",
                  size = 0.6) + 
  geom_point(mapping = aes(x = row_order, 
                           y = estimate),
             shape = 21,
             size = 5,
             stroke = 1,
             fill = "black") + 
  scale_y_continuous(limits = c(-1, 1),
                     breaks = seq(-1,
                                  1,
                                  by = 0.5)) +
  theme_minimal() +
  coord_flip()
coef.year.plot
ggsave("./model_plots/coefs/year.eps",
       coef.year.plot,
       width = 4,
       height = 4)
```

### Use `plot_summs`
```{r}
list2env(glm.output.list,
         envir = .GlobalEnv)

year.coef.plot <- plot_summs(`Bombus affinis`, 
                             `Bombus ashtoni`,
                             `Bombus auricomus`,
                             `Bombus bimaculatus`,
                             `Bombus borealis`,
                             `Bombus citrinus`,
                             `Bombus fervidus`,
                             `Bombus fraternus`, 
                             `Bombus impatiens`,
                             `Bombus pensylvanicus`,
                             `Bombus rufocinctus`,
                             `Bombus ternarius`,
                             `Bombus terricola`,
                             `Bombus vagans`,
                             `Bombus variabilis`,
                             model.names = c("B. affinis",
                                             "B. ashtoni",
                                             "B. auricomus",
                                             "B. bimaculatus",
                                             "B. borealis", 
                                             "B. citrinus",
                                             "B. fervidus",
                                             "B. fraternus",
                                             "B. impatiens",
                                             "B. pensylvanicus",
                                             "B. rufocinctus",
                                             "B. ternarius",
                                             "B. terricola",
                                             "B. vagans",
                                             "B. variablis"),
                             coefs = c("Year" = "bin_ag"),
                             colors = "inferno",
                             point.shape = FALSE,
                             plot.distributions = FALSE,
                             rescale.distributions = FALSE)
ncrop.coef.plot <- plot_summs(`Bombus affinis`, 
                              `Bombus ashtoni`,
                              `Bombus auricomus`,
                              `Bombus bimaculatus`,
                              `Bombus borealis`,
                              `Bombus citrinus`,
                              `Bombus fervidus`,
                              `Bombus fraternus`, 
                              `Bombus impatiens`,
                              `Bombus pensylvanicus`,
                              `Bombus rufocinctus`,
                              `Bombus ternarius`,
                              `Bombus terricola`,
                              `Bombus vagans`,
                              `Bombus variabilis`,
                              model.names = c("B. affinis",
                                              "B. ashtoni",
                                              "B. auricomus",
                                              "B. bimaculatus",
                                              "B. borealis", 
                                              "B. citrinus",
                                              "B. fervidus",
                                              "B. fraternus",
                                              "B. impatiens",
                                              "B. pensylvanicus",
                                              "B. rufocinctus",
                                              "B. ternarius",
                                              "B. terricola",
                                              "B. vagans",
                                              "B. variablis"),
                              coefs = c("n Crops" = "n_crops"),
                              colors = "inferno",
                              point.shape = FALSE,
                              plot.distributions = TRUE,
                              rescale.distributions = FALSE)
propcrop.coef.plot <- plot_summs(`Bombus affinis`, 
                                 `Bombus ashtoni`,
                                 `Bombus auricomus`,
                                 `Bombus bimaculatus`,
                                 `Bombus borealis`,
                                 `Bombus citrinus`,
                                 `Bombus fervidus`,
                                 `Bombus fraternus`, 
                                 `Bombus impatiens`,
                                 `Bombus pensylvanicus`,
                                 `Bombus rufocinctus`,
                                 `Bombus ternarius`,
                                 `Bombus terricola`,
                                 `Bombus vagans`,
                                 `Bombus variabilis`,
                                 model.names = c("B. affinis",
                                                 "B. ashtoni",
                                                 "B. auricomus",
                                                 "B. bimaculatus",
                                                 "B. borealis", 
                                                 "B. citrinus",
                                                 "B. fervidus",
                                                 "B. fraternus",
                                                 "B. impatiens",
                                                 "B. pensylvanicus",
                                                 "B. rufocinctus",
                                                 "B. ternarius",
                                                 "B. terricola",
                                                 "B. vagans",
                                                 "B. variablis"),
                                 coefs = c("Proportion cropland per county" = "prop_cropland"),
                                 colors = "inferno",
                                 point.shape = FALSE,
                                 plot.distributions = TRUE,
                                 rescale.distributions = FALSE)
year.coef.plot
ncrop.coef.plot
propcrop.coef.plot
```

# MODEL SPECIES RICHNESS
## Prep data
```{r}
spatial.bumbles.diverity.df <- spatial.bumbles.df %>%
  group_by(state, county, bin_ag) %>%
  distinct(species, .keep_all = TRUE) %>%
  summarise(n_species = n()) %>%
  left_join(midwestag.model.df,
            by = c("state" = "state",
                   "county" = "county",
                   "bin_ag" = "year")) %>%
  left_join(spatial.bumbles.df %>%
              ungroup() %>%
              group_by(bin_ag) %>%
              summarise(n_records = n()),
            by = c("bin_ag" = "bin_ag")) %>%
  filter(bin_ag < 2003)
spatial.bumbles.diverity.df
```

```{r}
diversity.glms <- function(data) {
  trend.plots.list <- list()
  propag.plots.list <- list()
  ncrops.plots.list <- list()
  glm.list <- list()
  df.list <- list()
  model.df <- data %>%
    filter(!is.na(prop_cropland))
  # print(model.df)
  glm.model <- glm(n_species ~
                     n_crops + 
                     prop_cropland +
                     # avgfarm + 
                     # cloverac + 
                     # pastureac + 
                     bin_ag,
                   data = model.df,
                   weights = model.df$n_records,
                   na.action = na.exclude,
                   family = poisson(link = "log"))
  glm.df <- tidy(glm.model) %>%
    mutate(n_records = nrow(glm.model$model)) %>%
    dplyr::select(term, 
                  n_records, 
                  everything())
  # glmqq.plot <- qqPlot(residuals(glm.model))
  # resid.plot <- plot(glm.model)
  glm.list[[i]] <- glm.model
  df.list[[i]] <- glm.df
  
  predict <- predictorEffects(glm.model,
                              axes = list(x = list(rug = TRUE)),
                              se = list(compute = TRUE))
  predict.df <- bind_rows(as.tibble(predict$n_crops) %>%
                            rename(new_x = n_crops) %>%
                            mutate(var = "n_crops"), 
                          as.tibble(predict$prop_cropland) %>%
                            rename(new_x = prop_cropland) %>%
                            mutate(var = "prop_cropland"),
                          as.tibble(predict$bin_ag) %>%
                            rename(new_x = bin_ag) %>%
                            mutate(var = "bin_ag"))
  trend.plot <- ggplot() + 
    geom_point(data = model.df ,
               mapping = aes(x = bin_ag,
                             y = n_species),
               shape = 21,
               fill = "black",
               color = "black",
               alpha = 1,
               position = position_jitter(width = 1.5)) + 
    geom_ribbon(data = predict.df %>%
                  filter(var == "bin_ag"),
                mapping = aes(x = new_x,
                              ymin = lower,
                              ymax = upper),
                fill = "#F22B29",
                color = "black",
                alpha = 1) +
    geom_line(data = predict.df %>%
                filter(var == "bin_ag"),
              mapping = aes(x = new_x,
                            y = fit),
              size = 1.25,
              color = "#F22B29") + 
    theme_minimal_grid() + 
    scale_x_continuous(limits = c(1870, 2020),
                       breaks = seq(1870, 2020, by = 20)) +
    ylab(label = "Estimated species richness") + 
    xlab(label = "Year")
  ggsave(plot = trend.plot,
         filename = "./model_plots/diversity/trend/diversity.eps",
         height = 3,
         width = 5)
  
  propag.plot <- ggplot() + 
    geom_point(data = model.df ,
               mapping = aes(x = prop_cropland,
                             y = n_species),
               shape = 21,
               fill = "black",
               color = "black",
               alpha = 1,
               position = position_jitter()) + 
    geom_ribbon(data = predict.df %>%
                  filter(var == "prop_cropland"),
                mapping = aes(x = new_x,
                              ymin = lower,
                              ymax = upper),
                fill = "#F49D37",
                color = "black",
                alpha = 1) +
    geom_line(data = predict.df %>%
                filter(var == "prop_cropland"),
              mapping = aes(x = new_x,
                            y = fit),
              size = 1.25,
              color = "#F49D37") + 
    theme_minimal_grid() + 
    # scale_x_continuous(limits = c(1870, 2020),
    #                    breaks = seq(1870, 2020, by = 20)) +
    ylab(label = "Estimated species richness") + 
    xlab(label = "Proportion of county in agriculture") + 
    labs(title = i)
  ggsave(plot = propag.plot,
         filename = "./model_plots/diversity/prop_crop/diversity.eps",
         height = 3,
         width = 5)
  
  ncrop.plot <- ggplot() + 
    geom_point(data = model.df ,
               mapping = aes(x = n_crops,
                             y = n_species),
               shape = 21,
               fill = "black",
               color = "black",
               alpha = 1,
               position = position_jitter()) + 
    geom_ribbon(data = predict.df %>%
                  filter(var == "n_crops"),
                mapping = aes(x = new_x,
                              ymin = lower,
                              ymax = upper),
                fill = "#140F2D",
                color = "black",
                alpha = 1) +
    geom_line(data = predict.df %>%
                filter(var == "n_crops"),
              mapping = aes(x = new_x,
                            y = fit),
              size = 1.25,
              color = "#140F2D") + 
    theme_minimal_grid() + 
    # scale_x_continuous(limits = c(1870, 2020),
    #                    breaks = seq(1870, 2020, by = 20)) +
    ylab(label = "Estimated species richness") + 
    xlab(label = "Number of crops grown") + 
    labs(title = i)
  ggsave(plot = ncrop.plot,
         filename = "./model_plots/diversity/ncrops/diversity.eps",
         height = 3,
         width = 5)
  print(trend.plot)
  print(propag.plot)
  print(ncrop.plot)
  trend.plots.list[[i]] <- trend.plot
  propag.plots.list[[i]] <- propag.plot
  ncrops.plots.list[[i]] <- ncrop.plot
  assign("glm.diversity.output.list",
         glm.list,
         envir = .GlobalEnv)
  assign("glm.diversity.df.list",
         df.list,
         envir = .GlobalEnv)
  assign("glm.diversity.trendplots.list",
         trend.plots.list,
         envir = .GlobalEnv)
}
```

## Run GLM Function
```{r}
diversity.glms(spatial.bumbles.diverity.df)
```


# PREDICT REL_ABUN
```{r}
pred.relabun <- function(model.list) {
  pred.list <- list()
  years.list <- list()
  years <- unique(midwestag.model.df$year)
  for (i in 1:length(model.list)) {
    for(j in years) {
      newdata.df <- midwestag.model.df %>%
        filter(year == j) %>%
        mutate(bin_ag = year)
      predict <- predict.glm(object = model.list[[i]],
                             newdata = newdata.df,
                             type = "response",
                             na.action = na.pass)
      predict.df <- tibble(rel_abun = predict,
                           species = names(glm.output.list[i]),
                           county = newdata.df$county,
                           state = newdata.df$state,
                           year = j)
      pred.list[[j]] <- predict.df
    }
    years.list[[i]] <- bind_rows(pred.list)
  }
  relabun_bycty.df <- bind_rows(years.list)
  assign("relabun_bycty.df",
         relabun_bycty.df,
         envir = .GlobalEnv)
}
pred.relabun(glm.output.list)
```

## Plot predicted relative abundance over time
```{r}
plot.predicted <- function() {
  plot.species <- c("Bombus affinis",
                        "Bombus auricomus",
                        "Bombus bimaculatus",
                        "Bombus borealis",
                        "Bombus citrinus",
                        "Bombus fervidus",
                        "Bombus griseocollis",
                        "Bombus impatiens",
                        "Bombus pensylvanicus",
                        "Bombus rufocinctus",
                        "Bombus ternarius",
                        "Bombus terricola",
                        "Bombus vagans")
  for(i in plot.species) {
    plot <- relabun_bycty.df %>%
      filter(year %in% c(1870, 1900, 1930, 1959, 1974, 2012)) %>%
      filter(species == i) %>%
      mutate(bin_ag = year) %>%
      mutate(state_full = abbr2state(state)) %>%
      full_join(ungroup(us.county.midwest),
                by = c("county" = "CNTY_NAME",
                       "state_full" = "region")) %>%
      filter(!is.na(species)) %>%
      ggplot() +
      geom_polygon(mapping = aes(x = long,
                                 y = lat,
                                 group = group,
                                 fill = rel_abun),
                   color = "gray80",
                   size = 0.25) + 
      geom_polygon(mapping = aes(x = long,
                                 y = lat,
                                 group = group),
                   color = "black",
                   fill = NA,
                   size = 0.25) + 
      geom_point(inherit.aes = FALSE,
                 data = spatial.bumbles.df %>%
                   filter(species == i) %>%
                   filter(bin_ag %in% c(1870, 1900, 1930, 1959, 1974, 2012)) %>%
                   group_by(bin_ag) %>%
                   sample_n(size = 50, replace = TRUE),
                 mapping = aes(x = dec_long,
                               y = dec_lat),
                 shape = 21,
                 fill = "tomato",
                 # color = "black",
                 size = 1) +
      coord_map("stereographic") +
      labs(title = i) +
      scale_fill_viridis_c(option = "inferno",
                           direction = 1,
                           ) +
      # scale_fill_gradient(low = "#FFFFFF",
      #                     high = "#59262F") +
      facet_grid(~ bin_ag) + 
      theme_void()
    ggsave(paste("./model_plots/predict_relabun/",
                 tolower(gsub(" ", "_", i)),
                 ".eps",
                 sep = ""),
           width = 6)
    print(plot)
  }
}
```

## Plot predicted
```{r}
plot.predicted()
```

# MODEL OTHER VAR (PEST/PASTRE)
## GLM function
```{r}
species.2.glms <- function(data) {
  species.list <- as.list(unique(data$species))
  glm.list <- list()
  df.list <- list()
  trend.plots.list <- list()
  pastureac.plots.list <- list()
  pestac.plots.list <- list()
  avgfarm.plots.list <- list()
  for (i in species.list) {
    model.df <- data %>%
      filter(species == i) %>%
      filter(!is.na(species))
    # print(model.df)
    glm.model <- glm(rel_abun ~ 
                       n_crops + 
                       prop_cropland +
                       prop_pasture + 
                       prop_pest + 
                       # avgfarm +
                       bin_ag,
                     data = model.df,
                     weights = model.df$bin_ag_abundance,
                     na.action = na.exclude,
                     family = binomial(link = "logit"))
    glm.df <- tidy(glm.model) %>%
      mutate(n_records = nrow(glm.model$model)) %>%
      dplyr::select(term, 
                    n_records, 
                    everything())
    # glmqq.plot <- qqPlot(residuals(glm.model))
    # resid.plot <- plot(glm.model)
    glm.list[[i]] <- glm.model
    df.list[[i]] <- glm.df
    
    predict <- predictorEffects(glm.model,
                                axes = list(x = list(rug = TRUE)),
                                se = list(compute = TRUE))
    predict.df <- bind_rows(as.tibble(predict$prop_pasture) %>%
                              rename(new_x = prop_pasture) %>%
                              mutate(var = "prop_pasture"),
                            as.tibble(predict$prop_pest) %>%
                              rename(new_x = prop_pest) %>%
                              mutate(var = "prop_pest"),
                            # as.tibble(predict$avgfarm) %>%
                            #   rename(new_x = avgfarm) %>%
                            #   mutate(var = "avgfarm"),
                            as.tibble(predict$bin_ag) %>%
                              rename(new_x = bin_ag) %>%
                              mutate(var = "bin_ag"))
    trend.plot <- ggplot() + 
      geom_point(data = model.df ,
                 mapping = aes(x = bin_ag,
                               y = rel_abun),
                 shape = 21,
                 fill = "black",
                 color = "black",
                 alpha = 1,
                 position = position_jitter(width = 1.5)) + 
      geom_ribbon(data = predict.df %>%
                    filter(var == "bin_ag"),
                  mapping = aes(x = new_x,
                                ymin = lower,
                                ymax = upper),
                  fill = "#F22B29",
                  color = "black",
                  alpha = 1) +
      geom_line(data = predict.df %>%
                  filter(var == "bin_ag"),
                mapping = aes(x = new_x,
                              y = fit),
                size = 1.25,
                color = "#F22B29") + 
      geom_rug(data = spatial.bumbles.df %>%
                 filter(species == i) %>%
                 mutate(rel_abun = 0),
               mapping = aes(x = year,
                             y = rel_abun),
               sides = "b",
               position = "jitter") + 
      theme_histbumbles() + 
      scale_x_continuous(limits = c(1970, 2020),
                         breaks = seq(1970, 2020, by = 10)) +
      scale_y_continuous(limits = c(0, 1),
                         breaks = c(0, 0.5, 1)) +
      ylab(label = "Proportional Abundance") + 
      xlab(label = "Year") + 
      labs(title = paste(i,
                         "proportional abundance 1870-present",
                         sep = " "))
    # ggsave(plot = trend.plot,
    #        filename = paste("./model_plots/trends/",
    #                         i,
    #                         ".eps",
    #                         sep = ""),
    #        height = 3,
    #        width = 5)
    
    pastureac.plot <- ggplot() + 
      geom_point(data = model.df ,
                 mapping = aes(x = prop_pasture,
                               y = rel_abun),
                 shape = 21,
                 fill = "black",
                 color = "black",
                 alpha = 1,
                 position = position_jitter()) + 
      geom_ribbon(data = predict.df %>%
                    filter(var == "prop_pasture"),
                  mapping = aes(x = new_x,
                                ymin = lower,
                                ymax = upper),
                  fill = "#140F2D",
                  color = "black",
                  alpha = 1) +
      geom_line(data = predict.df %>%
                  filter(var == "prop_pasture"),
                mapping = aes(x = new_x,
                              y = fit),
                size = 1.25,
                color = "#140F2D") + 
      theme_histbumbles() + 
      # scale_x_continuous(limits = c(1870, 2020),
      #                    breaks = seq(1870, 2020, by = 20)) +
      ylab(label = "Proportional abundance") + 
      xlab(label = "Proportion of county in pasture") + 
      labs(title = i)
    # ggsave(plot = ncrop.plot,
    #        filename = paste("./model_plots/ncrops/",
    #                         i,
    #                         ".eps",
    #                         sep = ""),
    #        height = 4,
    #        width = 5)
    #        
    # avgfarm.plot <- ggplot() + 
    #   geom_point(data = model.df ,
    #              mapping = aes(x = avgfarm,
    #                            y = rel_abun),
    #              shape = 21,
    #              fill = "black",
    #              color = "black",
    #              alpha = 1,
    #              position = position_jitter()) + 
    #   geom_ribbon(data = predict.df %>%
    #                 filter(var == "avgfarm"),
    #               mapping = aes(x = new_x,
    #                             ymin = lower,
    #                             ymax = upper),
    #               fill = "#140F2D",
    #               color = "black",
    #               alpha = 1) +
    #   geom_line(data = predict.df %>%
    #               filter(var == "avgfarm"),
    #             mapping = aes(x = new_x,
    #                           y = fit),
    #             size = 1.25,
    #             color = "#140F2D") + 
    #   theme_histbumbles() + 
    #   # scale_x_continuous(limits = c(1870, 2020),
    #   #                    breaks = seq(1870, 2020, by = 20)) +
    #   ylab(label = "Proportional Abundance") + 
    #   xlab(label = "Average Size of Farm (acres)") + 
    #   labs(title = i)
    # ggsave(plot = ncrop.plot,
    #        filename = paste("./model_plots/ncrops/",
    #                         i,
    #                         ".eps",
    #                         sep = ""),
    #        height = 4,
    #        width = 5)
    pestac.plot <- ggplot() + 
      geom_point(data = model.df ,
                 mapping = aes(x = prop_pest,
                               y = rel_abun),
                 shape = 21,
                 fill = "black",
                 color = "black",
                 alpha = 1,
                 position = position_jitter()) + 
      geom_ribbon(data = predict.df %>%
                    filter(var == "prop_pest"),
                  mapping = aes(x = new_x,
                                ymin = lower,
                                ymax = upper),
                  fill = "#140F2D",
                  color = "black",
                  alpha = 1) +
      geom_line(data = predict.df %>%
                  filter(var == "prop_peset"),
                mapping = aes(x = new_x,
                              y = fit),
                size = 1.25,
                color = "#140F2D") + 
      theme_histbumbles() + 
      # scale_x_continuous(limits = c(1870, 2020),
      #                    breaks = seq(1870, 2020, by = 20)) +
      ylab(label = "Proportional abundance") + 
      xlab(label = "Proportion of county treated with insecticides") + 
      labs(title = i)
    # ggsave(plot = ncrop.plot,
    #        filename = paste("./model_plots/ncrops/",
    #                         i,
    #                         ".eps",
    #                         sep = ""),
    #        height = 4,
    #        width = 5)
    print(trend.plot)
    print(pastureac.plot)
    # print(avgfarm.plot)
    print(pestac.plot)
    trend.plots.list[[i]] <- trend.plot
    pastureac.plots.list[[i]] <- pastureac.plot
    pestac.plots.list[[i]] <- pestac.plot
    # avgfarm.plots.list[[i]] <- avgfarm.plot
  }
  assign("glm.output2.list",
         glm.list,
         envir = .GlobalEnv)
  assign("glm.df2.list",
         df.list,
         envir = .GlobalEnv)
  # assign("glm.trendplots2.list",
  #        trend.plots.list,
  #        envir = .GlobalEnv)
}
```

## Run GLM2 function
```{r}
spatial.bumbles.glmvars2.df <- spatial.bumbles.glmvars.df %>%
  left_join(midwestag.othervars2.df,
            by = c("state" = "state_name",
                   "county" = "county_name")) %>%
  # dplyr::select(-c(crop_evenness, fertexp, covercropac)) %>%
  drop_na(prop_pasture, prop_pest) %>%
  filter(!species %in% c("Bombus ashtoni",
                         "Bombus fraternus",
                         "Bombus variabilis")) %>%
  filter(bin_ag_abundance > 5)
spatial.bumbles.glmvars2.df %>%
  group_by(species) %>%
  summarise(n = n())

species.2.glms(spatial.bumbles.glmvars2.df)
```

### Combine dataframe
```{r}
glms2.df <- bind_rows(glm.df2.list,
                      .id = "species")
glms2.df <- glms2.df %>%
  mutate(p.value = ifelse(p.value < 0.001,
                          "< 0.001",
                          round(p.value,
                                digits = 3)),
         estimate = round(estimate,
                          digits = 6),
         std.error = round(std.error,
                           digits = 5)) %>%
  write_csv("./model_output/sppglm2.csv")
glms2.df
```

## Plot GLM coefficients
### Use `ggplot`
#### Combine data (using scaled coefs)
```{r}
scale_coefs2 <- function(model.list) {
  df.list <- list()
  iter <- 0
  for (i in model.list) {
    iter <- iter + 1
    summ.glm <- summ(i,
                     scale = TRUE,
                     confint = TRUE)
    glm.df <- as.data.frame(summ.glm[["coeftable"]]) %>%
      mutate(term = c("(Intercept)",
                      "n_crops",
                      "prop_cropland",
                      "prop_pasture",
                      "prop_pest",
                      "bin_ag")) %>%
      dplyr::select("term" = "term",
                    "estimate" = "Est.",
                    "lower.ci" = "2.5%",
                    "upper.ci" = "97.5%",
                    "z.stat" = "z val.",
                    "p.value" = "p") %>%
      mutate(species = names(model.list[iter]),
             sample.size = length(summ.glm$model$y)) %>%
      dplyr::select(species, sample.size, everything())
    print(glm.df)
    df.list[[iter]] <- glm.df
  }
  glms.df <- bind_rows(df.list)
  assign("glms2.df",
         glms.df,
         envir = .GlobalEnv)
}

scale_coefs2(glm.output2.list)

glms2.df %>%
  mutate(p.value = ifelse(p.value < 0.001,
                          "< 0.001",
                          round(p.value,
                                digits = 3)),
         estimate = round(estimate,
                          digits = 3),
         lower.ci = round(lower.ci,
                           digits = 4),
         upper.ci = round(upper.ci,
                           digits = 4)) %>%
    write_csv("./model_output/sppglm2.csv")

```
#### pastureac
```{r}
coef.pastac.plot <- glms2.df %>%
  # filter(n_records > 60) %>%
  filter(term == "prop_pasture") %>%
  arrange(desc(estimate)) %>%
  mutate(row_order = factor(species,
                            levels = species)) %>%
  ggplot() + 
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "gray60",
             size = 0.6) + 
  geom_pointrange(mapping = aes(x = row_order,
                                y = estimate,
                                ymin = lower.ci,
                                ymax = upper.ci),
                  color = "black",
                  size = 0.6) + 
  geom_point(mapping = aes(x = row_order, 
                           y = estimate),
             shape = 21,
             size = 5,
             stroke = 1,
             fill = "black") + 
  # geom_text(data = glm.df[glm.df$p.value < 0.05, ],
  #           mapping = aes(x = term,
  #                         y = estimate),
  #           label = "*",
  #           position = position_dodge(width = 0.9)) +
  # scale_y_continuous(limits = c(-10, 2.5),
  #                    breaks = seq(-10,
  #                                 2.5,
  #                                 by = 2)) +
  theme_minimal() +
  coord_flip()
coef.pastac.plot
ggsave("./model_plots/coefs/pastac.eps",
       coef.pastac.plot,
       width = 4,
       height = 4)
```

#### pestac
```{r}
coef.pestac.plot <- glms2.df %>%
  # filter(n_records > 60) %>%
  filter(term == "prop_pest") %>%
  arrange(desc(estimate)) %>%
  mutate(row_order = factor(species,
                            levels = species)) %>%
  ggplot() + 
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "gray60",
             size = 0.6) + 
  geom_pointrange(mapping = aes(x = row_order,
                                y = estimate,
                                ymin = lower.ci,
                                ymax = upper.ci),
                  color = "black",
                  size = 0.6) + 
  geom_point(mapping = aes(x = row_order, 
                           y = estimate),
             shape = 21,
             size = 5,
             stroke = 1,
             fill = "black") + 
  # scale_y_continuous(limits = c(-0.3, 0.4),
  #                    breaks = round(seq(-0.3,
  #                                 0.3,
  #                                 by = 0.1),
  #                                 digits = 1)) +
  # geom_text(data = glm.df[glm.df$p.value < 0.05, ],
  #           mapping = aes(x = term,
  #                         y = estimate),
  #           label = "*",
  #           position = position_dodge(width = 0.9)) +
  theme_minimal() +
  coord_flip()
coef.pestac.plot
ggsave("./model_plots/coefs/pestac.eps",
       coef.pestac.plot,
       width = 4,
       height = 4)

```
#### prop_agriculture
```{r}
coef.pag2.plot <- glms2.df %>%
  # filter(n_records > 60) %>%
  filter(term == "prop_cropland") %>%
  arrange(desc(estimate)) %>%
  mutate(row_order = factor(species,
                            levels = species)) %>%
  ggplot() + 
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "gray60",
             size = 0.6) + 
  geom_pointrange(mapping = aes(x = row_order,
                                y = estimate,
                                ymin = lower.ci,
                                ymax = upper.ci),
                  color = "black",
                  size = 0.6) + 
  geom_point(mapping = aes(x = row_order, 
                           y = estimate),
             shape = 21,
             size = 5,
             stroke = 1,
             fill = "black") + 
  # scale_y_continuous(limits = c(-0.03, 0.03),
  #                    breaks = round(seq(-0.03,
  #                                       0.03,
  #                                       by = 0.01),
  #                                   digits = 2)) +
  # geom_text(data = glm.df[glm.df$p.value < 0.05, ],
  #           mapping = aes(x = term,
  #                         y = estimate),
  #           label = "*",
  #           position = position_dodge(width = 0.9)) +
  theme_minimal() +
  coord_flip()
coef.pag2.plot
ggsave("./model_plots/coefs/prop_cropland_2.eps",
       coef.pag2.plot,
       width = 4,
       height = 4)
```

#### n_crops
```{r}
coef.ncrops2.plot <- glms2.df %>%
  # filter(n_records > 60) %>%
  filter(term == "n_crops") %>%
  arrange(desc(estimate)) %>%
  mutate(row_order = factor(species,
                            levels = species)) %>%
  ggplot() + 
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "gray60",
             size = 0.6) + 
  geom_pointrange(mapping = aes(x = row_order,
                                y = estimate,
                                ymin = lower.ci,
                                ymax = upper.ci),
                  color = "black",
                  size = 0.6) + 
  geom_point(mapping = aes(x = row_order, 
                           y = estimate),
             shape = 21,
             size = 5,
             stroke = 1,
             fill = "black") + 
  # scale_y_continuous(limits = c(-0.03, 0.03),
  #                    breaks = round(seq(-0.03,
  #                                       0.03,
  #                                       by = 0.01),
  #                                   digits = 2)) +
  # geom_text(data = glm.df[glm.df$p.value < 0.05, ],
  #           mapping = aes(x = term,
  #                         y = estimate),
  #           label = "*",
  #           position = position_dodge(width = 0.9)) +
  theme_minimal() +
  coord_flip()
coef.ncrops2.plot
ggsave("./model_plots/coefs/n_crops_2.eps",
       coef.ncrops2.plot,
       width = 4,
       height = 4)
```

#### year
```{r}
coef.year2.plot <- glms2.df %>%
  # filter(n_records > 60) %>%
  filter(term == "bin_ag") %>%
  arrange(desc(estimate)) %>%
  mutate(row_order = factor(species,
                            levels = species)) %>%
  ggplot() + 
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "gray60",
             size = 0.6) + 
  geom_pointrange(mapping = aes(x = row_order,
                                y = estimate,
                                ymin = lower.ci,
                                ymax = upper.ci),
                  color = "black",
                  size = 0.6) + 
  geom_point(mapping = aes(x = row_order, 
                           y = estimate),
             shape = 21,
             size = 5,
             stroke = 1,
             fill = "black") + 
  # scale_y_continuous(limits = c(-0.03, 0.03),
  #                    breaks = round(seq(-0.03,
  #                                       0.03,
  #                                       by = 0.01),
  #                                   digits = 2)) +
  # geom_text(data = glm.df[glm.df$p.value < 0.05, ],
  #           mapping = aes(x = term,
  #                         y = estimate),
  #           label = "*",
  #           position = position_dodge(width = 0.9)) +
  theme_minimal() +
  coord_flip()
coef.year.plot
ggsave("./model_plots/coefs/year_2.eps",
       coef.year2.plot,
       width = 4,
       height = 4)
```


# RANGE/COUNTY SHIFTS
## Prep data
```{r}
spatial.bumbles.range.df <- bumbles.df %>%
  ungroup() %>%
  dplyr::select(species, subgenus, state, county, bin_15) %>%
  group_by(species, state) %>%
  distinct(county, .keep_all = TRUE) %>%
  group_by(species, bin_15) %>%
  summarise(n_counties = n()) %>%
  filter(species %in% c("Bombus affinis",
                        "Bombus auricomus",
                        "Bombus bimaculatus",
                        "Bombus borealis",
                        "Bombus citrinus",
                        "Bombus fervidus",
                        "Bombus griseocollis",
                        "Bombus impatiens",
                        "Bombus pensylvanicus",
                        "Bombus rufocinctus",
                        "Bombus ternarius",
                        "Bombus terricola",
                        "Bombus vagans")) %>%
  group_by(species) %>%
  mutate(time_point = row_number()) %>%
  mutate(year = case_when(time_point == 1 ~ 1869,
                          time_point == 2 ~ 1920,
                          time_point == 3 ~ 1931,
                          time_point == 4 ~ 1944,
                          time_point == 5 ~ 1956,
                          time_point == 6 ~ 1962,
                          time_point == 7 ~ 1966,
                          time_point == 8 ~ 1969,
                          time_point == 9 ~ 1971,
                          time_point == 10 ~ 1977,
                          time_point == 11 ~ 1987,
                          time_point == 12 ~ 2000,
                          time_point == 13 ~ 2009,
                          time_point == 14 ~ 2014,
                          time_point == 15 ~ 2018))

spatial.bumbles.range2.df <- spatial.bumbles.df %>%
  ungroup() %>%
  dplyr::select(species, subgenus, state, county, bin_8) %>%
  group_by(species, state) %>%
  distinct(county, .keep_all = TRUE) %>%
  group_by(species, state, bin_8) %>%
  summarise(n_counties = n()) %>%
  filter(species %in% c("Bombus affinis",
                        "Bombus auricomus",
                        "Bombus bimaculatus",
                        "Bombus borealis",
                        "Bombus citrinus",
                        "Bombus fervidus",
                        "Bombus griseocollis",
                        "Bombus impatiens",
                        "Bombus pensylvanicus",
                        "Bombus rufocinctus",
                        "Bombus ternarius",
                        "Bombus terricola",
                        "Bombus vagans")) %>%
  group_by(species, state) %>%
  mutate(time_point = row_number())

spatial.bumbles.range2.df





county.time.trend.plot <- spatial.bumbles.range.df %>%
  ggplot() + 
  geom_point(mapping = aes(x = year,
                           y = n_counties),
             shape = 21,
             size = 3,
             fill = "black") +
  geom_smooth(mapping = aes(x = year,
                            y = n_counties),
              method = "glm",
              #span = 1,
              se = TRUE,
              alpha = 1) + 
  # scale_x_continuous(limits = c(1840, 2020),
  #                    breaks = seq(1840, 2020, by = 30)) +
  # scale_y_continuous(limits = c(0, 250)) +
  facet_wrap(~ species) +
  theme_histbumbles()
county.time.trend.plot
  
ggsave("./model_plots/county_time_trends.eps",
       county.time.trend.plot,
       height = 6,
       width = 10)

```

### Use relative abundance of counties approach
```{r}
bumbles.df %>%
  ungroup() %>%
  dplyr::select(species, subgenus, state, county, bin_15) %>%
  group_by(species, state) %>%
  distinct(county, .keep_all = TRUE) %>%
  group_by(species, bin_15) %>%
  summarise(n_counties = n()) %>%
  filter(species %in% c("Bombus affinis",
                        "Bombus auricomus",
                        "Bombus bimaculatus",
                        "Bombus borealis",
                        "Bombus citrinus",
                        "Bombus fervidus",
                        "Bombus griseocollis",
                        "Bombus impatiens",
                        "Bombus pensylvanicus",
                        "Bombus rufocinctus",
                        "Bombus ternarius",
                        "Bombus terricola",
                        "Bombus vagans")) %>%
  left_join(bumbles.df %>%
              dplyr::select(species, subgenus, state, county, bin_15) %>%
              group_by(bin_15) %>%
              distinct(county, .keep_all = TRUE) %>%
              summarise(total_counties = n()),
            by = "bin_15") %>%
  ungroup() %>%
  group_by(species) %>%
  mutate(county_ra = n_counties / total_counties,
         time_point = row_number(),
         year = case_when(time_point == 1 ~ 1869,
                          time_point == 2 ~ 1920,
                          time_point == 3 ~ 1931,
                          time_point == 4 ~ 1944,
                          time_point == 5 ~ 1956,
                          time_point == 6 ~ 1962,
                          time_point == 7 ~ 1966,
                          time_point == 8 ~ 1969,
                          time_point == 9 ~ 1971,
                          time_point == 10 ~ 1977,
                          time_point == 11 ~ 1987,
                          time_point == 12 ~ 2000,
                          time_point == 13 ~ 2009,
                          time_point == 14 ~ 2014,
                          time_point == 15 ~ 2018)) %>%
  ggplot() + 
  geom_point(mapping = aes(x = year,
                           y = county_ra),
             shape = 21,
             size = 3,
             fill = "black") +
  geom_smooth(mapping = aes(x = year,
                            y = county_ra),
              method = "glm",
              #span = 1,
              se = TRUE,
              alpha = .1) + 
  # scale_x_continuous(limits = c(1840, 2020),
  #                    breaks = seq(1840, 2020, by = 30)) +
  # scale_y_continuous(limits = c(0, 250)) +
  facet_wrap(~ species) +
  theme_histbumbles()
    

  
```


## LM function
```{r}
range.lms <- function(data) {
  species <- unique(data$species)
  df.list <- list()
  for (i in species) {
    model.df <- data %>%
      filter(species == i)
    lm <- lm(n_counties ~ time_point,
               data = model.df)
    tidy.df <- tidy(lm) %>%
      mutate(species = i) %>%
      select(species, everything())
    print(tidy.df)
    print(plot(lm))
    df.list[[i]] <- tidy.df
  }
  dfs <- bind_rows(df.list)
  assign("range.lms.df",
         dfs,
         envir = .GlobalEnv)
}

range.lms(spatial.bumbles.range.df)
```

## GLM function
```{r}
range.glms <- function(data) {
  species <- unique(data$species)
  df.list <- list()
  glm.list <- list()
  for (i in species) {
    model.df <- data %>%
      filter(species == i)
    glm <- glm(n_counties ~ time_point,
               data = model.df,
               family = "poisson")
    # plot(glm)
    tidy.df <- tidy(glm) %>%
      mutate(species = i) %>%
      dplyr::select(species, everything())
    print(tidy.df)
    # print(acf(residuals(glm)))
    df.list[[i]] <- tidy.df
    glm.list[[i]] <- glm
  }
  dfs <- bind_rows(df.list)
  assign("range.glms.df",
         dfs,
         envir = .GlobalEnv)
  assign("range.glm.list",
         glm.list,
         envir = .GlobalEnv)
}

range.glms(spatial.bumbles.range.df)
```


## `nlme` function
```{r}
range.lms <- function(data) {
  library(nlme)
  species <- unique(data$species)
  df.list <- list()
  for (i in species) {
    model.df <- data %>%
      filter(species == i)
    gls <- gls(n_counties ~ bin_ag,
               data = model.df,
               correlation = corAR1(form = ~ bin_ag),
               weights = (model.df$sum_bees_allspp / 1000),
               na.action = na.exclude)
    gls
    tidy.df <- tidy(gls) %>%
      mutate(species = i) %>%
      select(species, everything())
    print(tidy.df)
    print(summary(gls))
    df.list[[i]] <- tidy.df
  }
  dfs <- bind_rows(df.list)
  assign("range.glms.df",
         dfs,
         envir = .GlobalEnv)
}

range.lms(spatial.bumbles.range.df)
```

## Plot LM coefficients
### Prep data
```{r}
scale_coefs3 <- function(model.list) {
  df.list <- list()
  iter <- 0
  for (i in model.list) {
    iter <- iter + 1
    summ.glm <- summ(i,
                     scale = TRUE,
                     confint = TRUE)
    glm.df <- as.data.frame(summ.glm[["coeftable"]]) %>%
      mutate(term = c("(Intercept)",
                      "time_point")) %>%
      dplyr::select("term" = "term",
                    "estimate" = "Est.",
                    "lower.ci" = "2.5%",
                    "upper.ci" = "97.5%",
                    "statistic" = "z val.",
                    "p.value" = "p") %>%
      mutate(species = names(model.list[iter]),
             sample.size = length(summ.glm$model$y)) %>%
      dplyr::select(species, sample.size, everything())
    print(glm.df)
    df.list[[iter]] <- glm.df
  }
  glms.df <- bind_rows(df.list)
  assign("glms3.df",
         glms.df,
         envir = .GlobalEnv)
}

scale_coefs3(range.glm.list)
```

### Plot coefs
```{r}
range.glm.plot1 <- glms3.df %>%
  filter(term == "time_point") %>%
  arrange(desc(estimate)) %>%
  mutate(row_order = factor(species,
                            levels = species)) %>%
  ggplot() + 
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "gray60",
             size = 0.6) + 
  geom_pointrange(mapping = aes(x = row_order,
                                y = estimate,
                                ymin = lower.ci,
                                ymax = upper.ci),
                  color = "black",
                  size = 0.6) + 
  geom_point(mapping = aes(x = row_order, 
                           y = estimate),
             shape = 21,
             size = 5,
             stroke = 1,
             fill = "black") + 
  # scale_y_continuous(limits = c(-0.015, 0.015),
  #                    breaks = round(seq(-0.015,
  #                                       0.015,
  #                                       by = 0.01),
  #                                   digits = 2)) +
  # geom_text(data = glm.df[glm.df$p.value < 0.05, ],
  #           mapping = aes(x = term,
  #                         y = estimate),
  #           label = "*",
  #           position = position_dodge(width = 0.9)) +
  theme_minimal() +
  coord_flip() + 
  ggsave("./model_plots/coefs/n_counties.eps",
       range.glm.plot1,
       width = 4,
       height = 4)
range.glm.plot1

```

# PREDICT RANGE GLMs
```{r}
pred.counties <- function(model.list) {
  pred.list <- list()
  newdata.df <- tibble(bin_ag = unique(midwestag.model.df$year),
                       bin_ag2 = bin_ag^2)
  print(newdata.df)
  for (i in 1:length(model.list)) {
    predict <- predict.glm(object = model.list[[i]],
                           newdata = newdata.df,
                           type = "response",
                           na.action = na.pass)
    predict.df <- tibble(ncounties = predict,
                         species = names(model.list[i]),
                         year = sort(newdata.df$bin_ag))
    # print(predict.df)
    pred.list[[i]] <- predict.df
  }
  ncounties.df <- bind_rows(pred.list)
  assign("ncounties.df",
         ncounties.df,
         envir = .GlobalEnv)
}
pred.counties(range.glm.list)
ncounties.df
```

## Plot GLM results
```{r}
ggplot(data = spatial.bumbles.range.df) + 
  geom_point(mapping = aes(x = bin_ag,
                           y = n_counties,
                           fill = species),
             shape = 21,
             color = "black") +
  geom_line(data = ncounties.df,
            mapping = aes(x = year,
                          y = ncounties)) +
  theme_minimal() + 
  facet_wrap(~ species,
             ncol = 4)
```

# Misc. exploration of ag stats patterns
```{r}
midwestag.model.df %>%
  ggplot() + 
  geom_jitter(mapping = aes(x = year,
                           y = n_crops,
                           color = state),
              alpha = 0.4) + 
  geom_smooth(mapping = aes(x = year,
                           y = n_crops,
                           color = state),
              method = "loess",
              se = FALSE,
              alpha = 0.05) +
  scale_color_viridis_d() +
  theme_minimal() + 
  theme(legend.position = "none")

midwestag.model.df %>%
  ggplot() + 
  geom_jitter(mapping = aes(x = year,
                           y = prop_cropland,
                           color = state),
              alpha = 0.4) + 
  geom_smooth(mapping = aes(x = year,
                           y = prop_cropland,
                           color = state),
              method = "loess",
              se = FALSE,
              alpha = 0.05) +
  scale_color_viridis_d() +
  theme_minimal() + 
  theme(legend.position = "none")

midwestag.model.df %>%
  filter(pastureac < 2000000) %>%
  ggplot() + 
  geom_jitter(mapping = aes(x = year,
                           y = pastureac,
                           color = state),
              alpha = 0.4) + 
  geom_smooth(mapping = aes(x = year,
                           y = pastureac,
                           color = state),
              method = "loess",
              se = FALSE,
              alpha = 0.05) +
  scale_color_viridis_d() +
  theme_minimal() + 
  theme(legend.position = "none")
  
midwestag.model.df %>%
  ggplot() + 
  geom_jitter(mapping = aes(x = year,
                           y = pestac,
                           color = state),
              alpha = 0.4) + 
  geom_smooth(mapping = aes(x = year,
                           y = pestac,
                           color = state),
              method = "lm",
              se = FALSE,
              alpha = 0.05) +
  scale_color_viridis_d() +
  scale_x_continuous(limits = c(1980, 2020)) +
  theme_minimal() + 
  theme(legend.position = "none")
```

```{r}
us.county.midwest %>%
  mutate(uniq = paste(region, CNTY_NAME)) %>%
  distinct(uniq)
```

# Bombus affinis exploration
```{r}
spatial.bumbles.glmvars.df %>%
  filter(species == "Bombus affinis") %>% 
  ggplot() +
  geom_jitter(mapping = aes(x = bin_ag,
                           y = rel_abun)) + 
  geom_smooth(mapping = aes(x = bin_ag,
                            y = rel_abun),
              method = "glm") + 
  facet_wrap(~state) + 
  theme_histbumbles()

spatial.bumbles.range2.df %>%
  filter(species == "Bombus affinis") %>% 
  ggplot() +
  geom_jitter(mapping = aes(x = time_point,
                           y = n_counties)) + 
  geom_smooth(mapping = aes(x = time_point,
                            y = n_counties),
              method = "glm") + 
  facet_wrap(~state) + 
  theme_histbumbles()
```

