---
title: "Ch4 | Historical Ag & Bumble Bee Abundance/Community Changes"
subtitle: "Historical ag census data cleanup & prep"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_notebook
---

**Name:** Jeremy Hemberger
**Email:** j.hemberger.wisc@gmail.com
**Institution:** University of Wisconsin - Madison | Department of Entomology

# Import libraries
```{r}
library(tidyverse)
library(maptools)
library(maps)
library(raster)
library(ggmap)
library(gridExtra)
library(gganimate)
library(transformr)
library(cowplot)
library(openintro)
```

# Load in Mike's proportion ag data
```{r}
histag2.df <- read_tsv("./AgCensus_MasterDataFrame.txt")
```

## Create crop code data frame
```{r}
cropcode.df <- tibble(crop_abbr = c("Brl",
                                    "Bkw",
                                    "Crn",
                                    "Ctn",
                                    "Flx",
                                    "Hay",
                                    "Oat",
                                    "Pnt",
                                    "Ptt",
                                    "Pls",
                                    "Ric",
                                    "Rye",
                                    "Sgm",
                                    "Soy",
                                    "Swt",
                                    "Sgc",
                                    "Tbc",
                                    "Wht",
                                    "Cat",
                                    "Hrs",
                                    "Hmn",
                                    "Shp",
                                    "Swn"),
                      crop_name = c("Barley",
                                    "Buckwheat",
                                    "Corn",
                                    "Cotton",
                                    "Flax",
                                    "Hay (Grass + Legume)",
                                    "Oats",
                                    "Peanuts",
                                    "Potato",
                                    "Pulses (Bean, pea, lentil)",
                                    "Rice",
                                    "Rye",
                                    "Sorghum",
                                    "Soybeans",
                                    "Sweet Potato",
                                    "Sugar Cane",
                                    "Tobacco",
                                    "Wheat",
                                    "Cattle",
                                    "Horse",
                                    "Human",
                                    "Sheep",
                                    "Swine"))
```


## Reshape from wide -> long form
```{r}
histag2.df <- histag2.df %>%
  gather(key = "crop_year",
         value = "prop_county",
         -c(STATE, COUNTY, FIPS, STCTY, AREA_KM, Bailey_Eco, USDA_FRR, Lon, Lat)) %>%
  separate(crop_year, 
           sep = 3,
           remove = FALSE,
           into = c("crop", "year")) %>%
  left_join(cropcode.df,
            by = c("crop" = "crop_abbr"))
histag2.df <- histag2.df %>%
  filter(!crop %in% c("Cat", "Hrs", "Hmn", "Shp", "Swn"))
histag2.df$year <- as.numeric(histag2.df$year)
histag2.df
```

## Trim down dataset to upper midwest
```{r}
midwestag.bycrop.df <- histag2.df %>%
  filter(STATE %in% c("IL", "IN", "IA", "MI", "MN", "WI"))
midwestag.bycrop.df
```

## Calculate county area in acres
```{r}
midwestag.countysize.df <- midwestag.bycrop.df %>%
  dplyr::select(state = STATE,
                county = COUNTY,
                area_km = AREA_KM) %>%
  separate(county,
           sep = -7,
           into = "county") %>%
  mutate(area_acres = area_km * 247.105)

us.countyarea.df <- read_csv("./us_countyarea.csv") 
midwest.countyarea.df <- us.countyarea.df %>%
  filter(state %in% c("IA", "IL", "IN", "MN", "MI", "WI"))
```

# Calculate ag predictors (Mike's data)
## Crop richness
```{r}
midwestag.richness.df <- midwestag.bycrop.df %>%
  filter(prop_county != 0) %>%
  group_by(STATE, COUNTY, year) %>%
  summarise(n_crops = n())
midwestag.richness.df %>%
  group_by(year) %>%
  summarise(mean = mean(n_crops),
            sd = sd(n_crops))
```
```{r}
agrichness.plot <- midwestag.richness.df %>%
  mutate(year.char = as.character(year)) %>%
ggplot() + 
  # geom_point(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  geom_smooth(mapping = aes(x = year,
                           y = n_crops,
                           color = STATE),
              se = FALSE) +
  # geom_boxplot(outlier.shape = NA) +
  # stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
  #                    colour = "red", size = 0.5) + 
  xlab(label = "Year") +
  ylab(label = "Number of crops grown") + 
  scale_x_continuous(limits = c(1870, 2010),
                     breaks = seq(1870, 2010, by = 20)) + 
  scale_color_viridis_d(option = "inferno") +
  theme_histbumbles()
  ggsave("./model_plots/agrichness_trend.eps",
         plot = agrichness.plot,
         height = 2,
         width = 4)
agrichness.plot
```

## Crop evenness (Simpson's E)
```{r}
midwestag.evenness.df <- midwestag.bycrop.df %>%
  #filter(prop_county >= 0.00001) %>%
  mutate(prop_count_rnd = round(prop_county, 
                                digits = 8)) %>%
  group_by(STATE, COUNTY, year) %>%
  summarise(numerator = round(-sum((prop_county * log(prop_county)),
                                  na.rm = TRUE),
                              digits = 3)) %>%
  left_join(midwestag.richness.df,
            by = c("STATE" = "STATE", 
                   "COUNTY" = "COUNTY", 
                   "year" = "year")) %>%
  mutate(crop_evenness = numerator / log(n_crops)) %>%
  filter(crop_evenness != Inf)
midwestag.evenness.df
```

```{r}
midwestag.evenness.df %>%
  filter(between(crop_evenness, 0, 1)) %>%
ggplot() + 
  # geom_point(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  # geom_smooth(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  geom_point(mapping = aes(x = year, 
                           y = crop_evenness,
                           color = STATE)) + 
  geom_smooth(mapping = aes(x = year, 
                           y = crop_evenness,
                           color = STATE),
              method = "lm") + 
  theme_minimal_hgrid()
```

## Crop coverage (proportion of county)
```{r}
midwestag.cropprop.df <- midwestag.bycrop.df %>%
  group_by(STATE, COUNTY, year) %>%
  summarise(prop_cropland = sum(prop_county))
midwestag.cropprop.df %>%
  group_by(year) %>%
  summarise(mean = mean(prop_cropland),
            sd = sd(prop_cropland))
```

```{r}
propag.plot <- midwestag.cropprop.df %>%
ggplot() + 
  # geom_point(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  # geom_smooth(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  # geom_point(mapping = aes(x = year, 
  #                          y = prop_cropland,
  #                          color = STATE)) + 
  geom_smooth(mapping = aes(x = year, 
                           y = prop_cropland,
                           color = factor(STATE)),
              se = FALSE) + 
  xlab(label = "Year") +
  ylab(label = "Proportion agriculture") + 
  scale_x_continuous(limits = c(1870, 2010),
                     breaks = seq(1870, 2010, by = 20)) + 
  scale_color_viridis_d(option = "inferno") +
  theme_histbumbles()
propag.plot
ggsave("./model_plots/propag_trend.eps",
       plot = propag.plot,
       height = 2,
       width = 4.3)
```


## Mechanistic vars (pasture + pesticides)
```{r}
midwestag.othervars2.df <- midwestag.othervars.df %>%
  right_join(midwest.countyarea.df, ###CHANGE THIS TO LEFT JOIN 
            by = c("state_name" = "state",
                   "county_name" = "county")) %>%
  mutate(prop_pasture = pastureac / area_acres_2000,
         prop_pest = pestac / area_acres_2000) %>% 
  filter(!county_name %in% c("Wisconsin", "Iowa", "Illinois", "Indiana", "Michigan", "Minnesota"))
```

## Combine data
```{r}
midwestag.vars.df <- midwestag.evenness.df %>%
  right_join(midwestag.cropprop.df,
            by = c("STATE" = "STATE", 
                   "COUNTY" = "COUNTY", 
                   "year" = "year")) %>% # This will include counties with 0 crop area/crops (NA?)
  separate(COUNTY,
           sep = -7,
           into = "county") %>%
  mutate(state = STATE) %>%
  dplyr::select(state, everything()) %>%
  ungroup() %>%
  dplyr::select(-STATE)
midwestag.vars.df <- midwestag.vars.df %>%
  replace_na(replace = list(n_crops = 0))



write_csv(midwestag.vars.df,
          "./midwestag_vars.csv")
```

## Visualize other data (From ag census records) 
```{r}
midwestag.othervars.df
midwestag.othervars.df %>%
  filter(countyicp != 0) %>%
ggplot() + 
  # geom_point(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  # geom_smooth(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  geom_point(mapping = aes(x = year, 
                           y = cloverac,
                           color = state_name)) + 
  geom_smooth(mapping = aes(x = year, 
                           y = cloverac,
                           color = state_name),
              method = "loess") + 
  theme_minimal_hgrid()
midwestag.othervars.df %>%
  filter(countyicp != 0) %>%
ggplot() + 
  # geom_point(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  # geom_smooth(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  geom_point(mapping = aes(x = year, 
                           y = pastureac,
                           color = state_name)) + 
  geom_smooth(mapping = aes(x = year, 
                           y = pastureac,
                           color = state_name),
              method = "loess") + 
  theme_minimal_hgrid()
midwestag.othervars.df %>%
  filter(avgfarm < 10000) %>%
ggplot() + 
  # geom_point(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  # geom_smooth(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  geom_point(mapping = aes(x = year, 
                           y = avgfarm,
                           color = state_name)) + 
  geom_smooth(mapping = aes(x = year, 
                           y = avgfarm,
                           color = state_name),
              method = "loess") + 
  theme_minimal_hgrid()
```

# Clean up ag census data
## Load in raw data
```{r}
histag <- read_csv("./2018_HistoricalAg_Pop.csv",
                   col_names = TRUE,
                   na = "NA")
```

## Split into ag-only data
```{r}
histag.ag <- histag %>%
  dplyr::select(-contains("POP")) %>%
  gather(key = ag_stat_name,
         value = ag_stat_value,
         contains("IFC"))
```

## Split into pop-only data
```{r}
histag.pop <- histag %>%
  dplyr::select(-contains("IFC")) %>%
  gather(key = pop_period,
         value = pop,
         contains("POP"))
```

## Parse out date, ag statistics from histag.ag
```{r}
histag.ag <- histag.ag %>%
  mutate(year = str_extract(ag_stat_name, "[:digit:]{4}"),
         stat = str_extract(ag_stat_name, "(?<=[:digit:]{4})[:alnum:]+"))
histag.ag$stat[histag.ag$stat == "R"] <- "RATIO"
```

## Save HistAg data
```{r}
write_csv(histag.ag,
          "./histag_clean.csv")
```


Quick plot of temporal trends

```{r}
us.county.50 <- read_csv("./counties.csv")
us.county.48 <- us.county.50 %>%
  filter(region != "alaska" & region != "hawaii")
rm(us.county.50)
us.county.48$region <- str_to_title(us.county.48$region)
us.county.48$subregion <- str_to_title(us.county.48$subregion)
names(us.county.48)[names(us.county.48) == 'subregion'] <- 'CNTY_NAME'

histag.plot.df <- left_join(us.county.48, 
                            histag.ag,
                            by = "CNTY_NAME")

base.us.state <- ggplot(data = us.county.48, 
                        mapping = aes(x = long,
                                      y = lat, 
                                      group = group)) + 
  coord_map("stereographic") + 
  geom_polygon(fill = "transparent",
               color = "gray80",
               size = 0.25) + 
  theme_minimal()
base.us.state

# histag.plot.df <- histag.plot.df %>%
  # filter(stat == "M2")

# ag.county <- base.us.state + 
  # geom_polygon(data = histag.plot.df, aes(fill = ag_stat_value))

# ag.county + facet_grid(rows = vars(year))
```

For loop plot of all ag maps
```{r}
ag.plots <- function() {
  years <- unique(histag.plot.df$year)
  plot.ls <- list()
  for (i in years) {
      plot.df <- histag.plot.df %>%
        filter(stat == "RATIO") %>%
        filter(year == i)
      plot <- base.us.state + 
        scale_fill_distiller(palette = "Oranges",
                             direction = 1,
                             limits = c(0,1),
                             na.value = "transparent",
                             name = "Cropland:County Area") + 
        geom_polygon(data = plot.df,
                     mapping = aes(fill = ag_stat_value)) + 
        labs(title = "Cropland : Total County Area",
             subtitle = i) + 
        theme(plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(hjust = 0.5))
      plot.ls[[i]] <- plot
  }
  assign("ag.plots",
         plot.ls,
         envir = .GlobalEnv)
}
ag.plots()
```

Export all `ag.plots` to image, combine externally to gif (due to gganimate memory restrictions)

```{r}
export.plots <- function() {
  for (i in 1:length(ag.plots)) {
  ggsave(filename = paste("plot", 
                          names(ag.plots[i]), 
                          ".png", 
                          sep = ""),
         plot = ag.plots[[i]])
    }
}
export.plots()
```


Proportion of Dane county 
```{r}
histag.df %>%
  filter(CNTY_NAME == "Columbia" & STATE_NAME == "Wisconsin" & stat == "RATIO") %>%
  ggplot() + 
  geom_col(mapping = aes(x = year,
                         y = ag_stat_value)) +
  theme_minimal()
```

# Agriculture in Midwest
## Split data
```{r}
str(histag.df)

midwestag.df <- histag.df %>%
  filter(STATE_NAME %in% c("Wisconsin",
                      "Michigan",
                      "Iowa",
                      "Illinois",
                      "Indiana",
                      "Minnesota")) 
str(midwestag.df)
str(us.county.midwest)
```

## Plot `prop_cropland` over time
```{r}
midwestag.plot.df <- midwestag.df %>%
  dplyr::select(STATE_NAME, CNTY_NAME, ag_stat_name, ag_stat_value, year) %>%
  left_join(us.county.midwest,
            by = c("CNTY_NAME" = "CNTY_NAME"))

no_classes = 8
pcrop_quantiles <- stats::quantile(midwestag.vars.df$prop_cropland, 
                            na.rm = TRUE, 
                            type = 6,
                            probs = seq(0, 1, length.out = no_classes + 1))
pcrop_quantiles
pcrop_labels <- c("0-0.02", "0.02-0.11", "0.11-0.26", "0.26-0.38", "0.38-0.47", 
                  "0.47-0.55", "0.55-0.66", "0.66-1.0")


midwestag.vars.df$pcrop_brks <- cut(midwestag.vars.df$prop_cropland, 
                                    breaks = pcrop_quantiles, 
                                    include.lowest = TRUE,
                                    labels = pcrop_labels)
pcrop_brks_scale <- levels(midwestag.vars.df$pcrop_brks)

propcrop.plot <- midwestag.vars.df %>%
  mutate(full_state = abbr2state(state)) %>%
  left_join(us.county.midwest,
            by = c("county" = "CNTY_NAME",
                   "full_state" = "region")) %>%
  filter(year %in% c(1850, 1880, 1900, 1950, 1974, 2012)) %>%
  ggplot() + 
  geom_polygon(mapping = aes(x = long,
                             y = lat,
                             group = group,
                             fill = pcrop_brks)) +
  geom_polygon(data = us.county.midwest,
               mapping = aes(x = long,
                             y =lat,
                             group = group),
               fill = "transparent",
               color = "#3A3A39",
               size = 0.25) +
  scale_fill_manual(values = rev(viridis::inferno(8, direction = -1)),
                    breaks = rev(pcrop_brks_scale),
                    name = "Proportion cropland in county",
                    drop = FALSE,
                    labels = rev(pcrop_brks_scale)) +  
  # scale_fill_gradient(low = "#FFFFFF",
  #                     high = "#FCAC25",
  #                     na.value = "#3A3A39",
  #                     name = "Proportion cropland") +
  coord_map("stereographic") + 
  labs(title = "Cropland : Total County Area") + 
  facet_wrap(~ year,
             ncol = 6) +
  theme_void()
propcrop.plot
ggsave("./model_plots/propcrop_overtime.eps",
       propcrop.plot,
       width = 10)
```

## Plot `n_crops` over time
```{r}
no_classes = 8
ncrop_quantiles <- stats::quantile(midwestag.vars.df$n_crops, 
                            na.rm = TRUE, 
                            type = 1,
                            probs = seq(0, 1, length.out = no_classes + 1))
ncrop_quantiles
ncrop_labels <- c("0-4", "5-8", "9-10", "11", "12", "13-14", "15-16")
ncrop_labels <- c("2-8", "8-10", "11", "12", "13", "14", "15-16")


midwestag.vars.df$ncrop_brks <- cut(midwestag.vars.df$n_crops, 
                                    breaks = c(0, 4, 8, 10, 11, 12, 14, 16), 
                                    include.lowest = TRUE,
                                    labels = ncrop_labels)
ncrop_brks_scale <- levels(midwestag.vars.df$ncrop_brks)


ncrop.plot <- midwestag.vars.df %>%
  mutate(full_state = abbr2state(state)) %>%
  left_join(us.county.midwest,
            by = c("county" = "CNTY_NAME",
                   "full_state" = "region")) %>%
  filter(year %in% c(1850, 1880, 1900, 1950, 1974, 2012)) %>%
  ggplot() + 
  geom_polygon(mapping = aes(x = long,
                             y = lat,
                             group = group,
                             fill = ncrop_brks)) +
  geom_polygon(data = us.county.midwest,
               mapping = aes(x = long,
                             y =lat,
                             group = group),
               fill = "transparent",
               color = "#3A3A39",
               size = 0.25) +
  scale_fill_manual(values = rev(viridis::inferno(8, direction = -1)),
                    breaks = rev(ncrop_brks_scale),
                    name = "Number of crops grown",
                    drop = FALSE,
                    labels = rev(ncrop_brks_scale)) +
  # scale_fill_gradient(low = "#FFFFFF",
  #                     high = "#821E67",
  #                     na.value = "#3A3A39",
  #                     name = "Number of Crops") +
  coord_map("stereographic") + 
  facet_wrap(~ year,
             ncol = 6) +
  theme_void()
ncrop.plot
ggsave("./model_plots/richovertime.eps",
       ncrop.plot,
       width = 10)
```

## Plot `pastureac` over time
```{r}
no_classes = 8
ppast_quantiles <- midwestag.othervars2.df %>%
  filter(!county_name %in% c("Wisconsin", "Iowa", "Illinois", "Indiana", "Michigan", "Minnesota"))
ppast_quantiles <- stats::quantile(ppast_quantiles$prop_pasture, 
                            na.rm = TRUE, 
                            type = 6,
                            probs = seq(0, 1, length.out = no_classes + 1))
ppast_quantiles
ppast_labels <- c("0-0.004", "0.004-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.06", "0.06-0.09", "0.09-0.16", "0.16-0.53")


midwestag.othervars2.df$ppast_brks <- cut(midwestag.othervars2.df$prop_pasture, 
                                          breaks = ppast_quantiles, 
                                          include.lowest = TRUE,
                                          labels = ppast_labels)
ppast_brks_scale <- levels(midwestag.othervars2.df$ppast_brks)

pastureac.plot <- midwestag.othervars2.df %>%
  mutate(full_state = abbr2state(state_name)) %>%
  left_join(us.county.midwest,
            by = c("county_name" = "CNTY_NAME",
                   "full_state" = "region")) %>%
  filter(year %in% c(1982, 1992, 2002, 2012)) %>%
  ggplot() + 
  geom_polygon(mapping = aes(x = long,
                             y = lat,
                             group = group,
                             fill = ppast_brks)) +
  geom_polygon(data = us.county.midwest,
               mapping = aes(x = long,
                             y =lat,
                             group = group),
               fill = "transparent",
               color = "#3A3A39",
               size = 0.25) +
  scale_fill_manual(values = rev(viridis::inferno(8, direction = -1)),
                    breaks = rev(ppast_brks_scale),
                    name = "Proportion county in pasture",
                    drop = FALSE,
                    labels = rev(ppast_brks_scale)) +
  # scale_fill_gradient(low = "#FFFFFF",
  #                     high = "#F9A242",
  #                     na.value = "#FFFFFF",
  #                     name = "Acres of Pasture") +
  coord_map("stereographic") + 
  facet_wrap(~ year,
             ncol = 6) +
  theme_void()
pastureac.plot
ggsave("./model_plots/pastureac.eps",
       pastureac.plot,
       width = 10)

midwestag.othervars2.df %>%
ggplot() + 
  # geom_point(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  geom_smooth(mapping = aes(x = year,
                           y = prop_pasture,
                           color = state_name),
              method = "loess",
              span = 1,
              se = FALSE) +
  # geom_boxplot(outlier.shape = NA) +
  # stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
  #                    colour = "red", size = 0.5) + 
  xlab(label = "Year") +
  ylab(label = "Proportion county in pasture") + 
  scale_x_continuous(limits = c(1982, 2012),
                     breaks = seq(1982, 2012, by = 10)) + 
  scale_color_viridis_d(option = "inferno") + 
  #scale_color_gradientn(colors = viridis::inferno(6)) + 
  theme_histbumbles() +
  ggsave("./model_plots/pastureac_trend.eps",
         height = 2,
         width = 4)
```

## Plot `pestac` over time
```{r}
no_classes = 8
ppest_quantiles <- midwestag.othervars2.df %>%
  filter(!county_name %in% c("Wisconsin", "Iowa", "Illinois", "Indiana", "Michigan", "Minnesota"))
ppest_quantiles <- stats::quantile(ppest_quantiles$prop_pest, 
                            na.rm = TRUE, 
                            type = 6,
                            probs = seq(0, 1, length.out = no_classes + 1))
ppest_quantiles
ppest_labels <- c("0-0.007", "0.007-0.03", "0.03-0.06", "0.06-0.09", "0.09-0.12", "0.12-0.16", "0.16-0.23", "0.23-0.55")


midwestag.othervars2.df$ppest_brks <- cut(midwestag.othervars2.df$prop_pest, 
                                          breaks = ppest_quantiles, 
                                          include.lowest = TRUE,
                                          labels = ppest_labels)
ppest_brks_scale <- levels(midwestag.othervars2.df$ppest_brks)

pestac.plot <- midwestag.othervars2.df %>%
  mutate(full_state = abbr2state(state_name)) %>%
  left_join(us.county.midwest,
            by = c("county_name" = "CNTY_NAME",
                   "full_state" = "region")) %>%
  filter(year %in% c(1982, 1992, 2002, 2012)) %>%
  ggplot() + 
  geom_polygon(mapping = aes(x = long,
                             y = lat,
                             group = group,
                             fill = ppest_brks)) +
  geom_polygon(data = us.county.midwest,
               mapping = aes(x = long,
                             y =lat,
                             group = group),
               fill = "transparent",
               color = "#3A3A39",
               size = 0.25) +
  scale_fill_manual(values = rev(viridis::inferno(8, direction = -1)),
                    breaks = rev(ppest_brks_scale),
                    name = "Proportion county treated with insecticides",
                    drop = FALSE,
                    labels = rev(ppest_brks_scale)) +
  # scale_fill_gradient(low = "#FFFFFF",
  #                     high = "#D04940",
  #                     na.value = "#FFFFFF",
  #                     name = "Insecticide treated acreage") +
  coord_map("stereographic") + 
  facet_wrap(~ year,
             ncol = 6) +
  theme_void()
pestac.plot
ggsave("./model_plots/pestac.eps",
       pestac.plot,
       width = 10)

midwestag.othervars2.df %>%
ggplot() + 
  # geom_point(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  geom_smooth(mapping = aes(x = year,
                           y = prop_pest,
                           color = state_name),
              method = "loess",
              span = 1.5,
              se = FALSE) +
  # geom_boxplot(outlier.shape = NA) +
  # stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
  #                    colour = "red", size = 0.5) + 
  xlab(label = "Year") +
  ylab(label = "Proportion county treated with insecticides") + 
  scale_x_continuous(limits = c(1982, 2012),
                     breaks = seq(1982, 2012, by = 10)) + 
  scale_color_viridis_d(option = "inferno") + 
  theme_histbumbles() + 
  ggsave("./model_plots/pestac_trend.eps",
         height = 2,
         width = 4)
```

# Calculate mean ag stats per year
```{r}
midwestag.othervars2.df %>%
  filter(year %in% c(1982, 1992, 2002, 2012)) %>%
  dplyr::select(year, prop_pest, prop_pasture) %>%
  group_by(year) %>%
  summarise(mean.pest = mean(prop_pest, na.rm = TRUE),
            se.pest = sd(prop_pest, na.rm = TRUE) / sqrt(length(!is.na(prop_pest))),
            mean.past = mean(prop_pasture, na.rm = TRUE),
            se.past = sd(prop_pasture, na.rm = TRUE) / sqrt(length(!is.na(prop_pasture))))

midwestag.vars.df %>%
  filter(year %in% c(1850, 1880, 1900, 1950, 1974, 2012)) %>%
  dplyr::select(year, n_crops, prop_cropland) %>%
  group_by(year) %>%
  summarise(mean.pcrop = mean(prop_cropland, na.rm = TRUE),
            se.pcrop = sd(prop_cropland, na.rm = TRUE) / sqrt(length(!is.na(prop_cropland))),
            mean.ncrop = mean(n_crops, na.rm = TRUE),
            se.ncrop = sd(n_crops, na.rm = TRUE) / sqrt(length(!is.na(n_crops))))

```

# Calculate change in ag over time
## Demo w/1 county
```{r}
midwestag.df %>%
  filter(CNTY_NAME == "Columbia" & STATE_NAME == "Wisconsin" & stat == "RATIO") %>%
  group_by(STATE_NAME, CNTY_NAME, stat) %>%
  arrange(STATE_NAME, CNTY_NAME, year) %>%
  filter(stat == "RATIO") %>%
  mutate(ag_delta = ag_stat_value - lag(ag_stat_value)) %>%
  summarise(mean_ag_delta = mean(ag_delta,
                                 na.rm = TRUE)) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = mean_ag_delta)) +
  theme_minimal()
# midwestag.df
# write_csv(midwestag.df,
#           "./midwestag.csv")
```

# Yields of corn over time
```{r}
agyields.df <- read_csv("./agyields_historic.csv")
agyields.df
```

## Plot yield over time
```{r}
agyields.df %>%
  filter(!is.na(`yield/acre`)) %>%
  ggplot() + 
  geom_point(mapping = aes(x = year,
                           y = `yield/acre`)) + 
  geom_smooth(mapping = aes(x = year,
                           y = `yield/acre`,
                           color = state),
              se = FALSE) + 
  geom_smooth(mapping = aes(x = year,
                            y = `yield/acre`),
              color = "red",
              size = 2,
              se = FALSE) +
  theme_classic()
```


# Correct county names between databases
```{r}
midwestag.vars.df %>%
  dplyr::distinct(county)

us.county.midwest %>%
  dplyr::distinct(CNTY_NAME)


midwestag.vars.df %>%
  mutate(full_state = abbr2state(state)) %>%
  left_join(us.county.midwest,
            by = c("county" = "CNTY_NAME",
                   "full_state" = "region")) %>%
  filter(year %in% c(2012)) %>%
  ggplot() + 
  geom_polygon(data = us.county.midwest %>%
                 filter(CNTY_NAME == "Shelby"),
               mapping = aes(x = long,
                             y =lat,
                             group = group),
               fill = "transparent",
               color = "#3A3A39",
               size = 0.25) +
  geom_text_repel(data = us.county.midwest %>%
              group_by(region, CNTY_NAME) %>%
              slice(2),
            mapping = aes(x = long, 
                          y = lat,
                          label = CNTY_NAME),
            min.segment.length = 0.1) + 
  coord_map("stereographic") + 
  theme_void()


midwestag.vars.df <- midwestag.vars.df %>%
  mutate(full_state = abbr2state(state))

test.agstats <- midwestag.vars.df %>%
  # filter(county == "O' Brien") %>%
  filter(state == "IN")

test.us.counties <- us.county.midwest %>%
  # filter(CNTY_NAME == "MacHenry")
  filter(region == "Indiana")

# Make US counties match ag stats nomenclature 
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "St Louis"] <- "Saint Louis"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "Lake Of The Woods"] <- "Lake of the Woods"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "St Clair"] <- "Saint Clair"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "Lac Qui Parle"] <- "Lac qui Parle"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "Mcleod"] <- "McLeod"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "St Croix"] <- "Saint Croix"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "Fond Du Lac"] <- "Fond du Lac"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "Mchenry"] <- "McHenry"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "Dekalb"] <- "DeKalb"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "De Kalb"] <- "DeKalb"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "Du Page"] <- "DuPage"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "Mclean"] <- "McLean"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "Mcdonough"] <- "McDonough"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "La Porte"] <- "LaPorte"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "St Joseph"] <- "Saint Joseph"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "LeGrange"] <- "LaGrange"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "St Joseph"] <- "Saint Joseph"
us.county.midwest$CNTY_NAME[us.county.midwest$CNTY_NAME == "Obrien"] <- "O'Brien"

test.join <- midwestag.vars.df %>%
  mutate(full_state = abbr2state(state)) %>%
  full_join(us.county.midwest,
            by = c("county" = "CNTY_NAME",
                   "full_state" = "region")) 
```

```{r}
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "St. Louis"] <- "Saint Louis"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "Lake Of The Woods"] <- "Lake of the Woods"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "St. Clair"] <- "Saint Clair"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "Lac Qui Parle"] <- "Lac qui Parle"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "Mcleod"] <- "McLeod"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "St. Croix"] <- "Saint Croix"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "Fond Du Lac"] <- "Fond du Lac"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "Mchenry"] <- "McHenry"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "Dekalb"] <- "DeKalb"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "De Kalb"] <- "DeKalb"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "Du Page"] <- "DuPage"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "Mclean"] <- "McLean"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "Mcdonough"] <- "McDonough"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "La Porte"] <- "LaPorte"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "St. Joseph"] <- "Saint Joseph"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "Lagrange"] <- "LaGrange"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "St. Joseph"] <- "Saint Joseph"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "O''Brien"] <- "O'Brien"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "O'brien"] <- "O'Brien"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "St Joseph"] <- "Saint Joseph"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "St Louis"] <- "Saint Louis"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "St Clair"] <- "Saint Clair"
midwestag.othervars.df$county_name[midwestag.othervars.df$county_name == "St Croix"] <- "Saint Croix"
```

```{r}
midwest.countyarea.df$county[midwest.countyarea.df$county == "St. Louis"] <- "Saint Louis"
midwest.countyarea.df$county[midwest.countyarea.df$county == "Lake Of The Woods"] <- "Lake of the Woods"
midwest.countyarea.df$county[midwest.countyarea.df$county == "St. Clair"] <- "Saint Clair"
midwest.countyarea.df$county[midwest.countyarea.df$county == "Lac Qui Parle"] <- "Lac qui Parle"
midwest.countyarea.df$county[midwest.countyarea.df$county == "Mcleod"] <- "McLeod"
midwest.countyarea.df$county[midwest.countyarea.df$county == "St. Croix"] <- "Saint Croix"
midwest.countyarea.df$county[midwest.countyarea.df$county == "Fond Du Lac"] <- "Fond du Lac"
midwest.countyarea.df$county[midwest.countyarea.df$county == "Mchenry"] <- "McHenry"
midwest.countyarea.df$county[midwest.countyarea.df$county == "Dekalb"] <- "DeKalb"
midwest.countyarea.df$county[midwest.countyarea.df$county == "De Kalb"] <- "DeKalb"
midwest.countyarea.df$county[midwest.countyarea.df$county == "Du Page"] <- "DuPage"
midwest.countyarea.df$county[midwest.countyarea.df$county == "Mclean"] <- "McLean"
midwest.countyarea.df$county[midwest.countyarea.df$county == "Mcdonough"] <- "McDonough"
midwest.countyarea.df$county[midwest.countyarea.df$county == "La Porte"] <- "LaPorte"
midwest.countyarea.df$county[midwest.countyarea.df$county == "St. Joseph"] <- "Saint Joseph"
midwest.countyarea.df$county[midwest.countyarea.df$county == "LeGrange"] <- "LaGrange"
midwest.countyarea.df$county[midwest.countyarea.df$county == "St. Joseph"] <- "Saint Joseph"
midwest.countyarea.df$county[midwest.countyarea.df$county == "O''Brien"] <- "O'Brien"
midwest.countyarea.df$county[midwest.countyarea.df$county == "O'brien"] <- "O'Brien"
midwest.countyarea.df$county[midwest.countyarea.df$county == "St Joseph"] <- "Saint Joseph"
midwest.countyarea.df$county[midwest.countyarea.df$county == "St Louis"] <- "Saint Louis"
midwest.countyarea.df$county[midwest.countyarea.df$county == "St Clair"] <- "Saint Clair"
midwest.countyarea.df$county[midwest.countyarea.df$county == "St Croix"] <- "Saint Croix"
midwest.countyarea.df$county[midwest.countyarea.df$county == "LaSalle"] <- "La Salle"
```


```{r}
test <- midwestag.vars.df %>%
  filter(year == 2012)
hist(test$n_crops)
```

