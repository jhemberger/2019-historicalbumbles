---
title: "Ch4 | Historical Ag & Bumble Bee Abundance/Community Changes"
subtitle: "Historical bumble bee data combination and modeling"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_notebook
---

**Name:** Jeremy Hemberger
**Email:** j.hemberger.wisc@gmail.com
**Institution:** University of Wisconsin - Madison | Department of Entomology

# Import packages
```{r} 
library(tidyverse)
library(rgdal)
library(ggmap)
library(ggalt)
library(ggforce)
library(cowplot)
library(raster)
library(maptools)
library(maps)
library(mapdata)
library(mp)
library(vegan)
library(iNEXT)
library(magrittr)
library(openintro)
library(lme4)
library(lmerTest)
library(coin)
library(rbin)
library(directlabels)
```

# Import data
`bumbles.df` data are cleaned in `C2019_HistBumble_DataCleanup.rmd`.  Briefly, data from GBIF and Bumblebee Watch are combined, cleaned, filtered, and restricted to upper Midwest states.  

`histag.df` data are cleaned and prepped in `C2019_HistAg_DataCleanup.Rmd`.  Not much done other than filtering out population data.
```{r}
bumbles.df <- read_csv("./analysis_bumbles.csv")
histag.df <- read_csv("./histag_clean.csv")
```

# Data preparation 
## Split bumble bee data by quantile (equal records per period)
```{r}
bumbles.df <- bumbles.df %>%
  filter(!is.na(year)) %>%
  mutate(subgenus = ifelse(species %in% c("Bombus affinis",
                                          "Bombus terricola"),
                           "Bombus",
                           ifelse(species %in% c("Bombus griseocollis",
                                                 "Bombus rufocinctus",
                                                 "Bombus fraternus"),
                                  "Cullumanobombus",
                                  ifelse(species %in% c("Bombus vagans",
                                                        "Bombus bimaculatus",
                                                        "Bombus impatiens",
                                                        "Bombus ternarius",
                                                        "Bombus perplexus",
                                                        "Bombus sandersoni"),
                                         "Pyrobombus",
                                         ifelse(species %in% c("Bombus auricomus"),
                                                "Bombias",
                                                ifelse(species %in% c("Bombus fervidus",
                                                                      "Bombus pensylvanicus"),
                                                       "Thoracobombus",
                                                       ifelse(species %in% c("Bombus citrinus",
                                                                              "Bombus variabilis",
                                                                              "Bombus ashtoni"),
                                                              "Psithyrus",
                                                              "Subterraneobombus")))))))
```

## 8 bins
```{r}
bin8.bumbles.df <- rbin_quantiles(data = bumbles.df, 
                                  response = species,
                                  predictor = year,
                                  bins = 8)
bin8.bumbles.df
bumbles.df <- bumbles.df %>%
  mutate(bin_8 = case_when(
    year < 1925 ~ "1824-1925",
    between(year, 1925, 1950) ~ "1926-1950",
    between(year, 1950, 1963) ~ "1951-1963",
    between(year, 1963, 1969) ~ "1964-1969",
    between(year, 1969, 1977) ~ "1970-1977",
    between(year, 1977, 1996) ~ "1978-1996",
    between(year, 1996, 2013) ~ "1997-2013",
    between(year, 2013, 2019) ~ "2014-present"
  ))
bumbles.df$bin_8 <- factor(bumbles.df$bin_8,
                           levels = c("1824-1925",
                                      "1926-1950",
                                      "1951-1963",
                                      "1964-1969",
                                      "1970-1977",
                                      "1978-1996",
                                      "1997-2013",
                                      "2014-present"))
table(bumbles.df$bin_8)
```

## 5 bins
```{r}
bin5.bumbles.df <- rbin_quantiles(data = bumbles.df, 
                                  response = species,
                                  predictor = year,
                                  bins = 5)
bin5.bumbles.df
bumbles.df <- bumbles.df %>%
  mutate(bin_5 = case_when(
    year < 1937 ~ "1824-1937",
    between(year, 1937, 1964) ~ "1937-1964",
    between(year, 1964, 1972) ~ "1965-1972",
    between(year, 1972, 2005) ~ "1973-2005",
    between(year, 2005, 2019) ~ "2006-present"
  ))
bumbles.df$bin_5 <- factor(bumbles.df$bin_5,
                           levels = c("1824-1937",
                                      "1937-1964",
                                      "1965-1972",
                                      "1973-2005",
                                      "2006-present"))
table(bumbles.df$bin_5)
```

## 3 bins
```{r}
bin3.bumbles.df <- rbin_quantiles(data = bumbles.df, 
                                  response = species,
                                  predictor = year,
                                  bins = 3)
bin3.bumbles.df
bumbles.df <- bumbles.df %>%
  mutate(bin_3 = case_when(
    year < 1960 ~ "1824-1960",
    between(year, 1960, 1982) ~ "1961-1982",
    between(year, 1982, 2019) ~ "1983-present",
  ))
bumbles.df$bin_3 <- factor(bumbles.df$bin_3,
                           levels = c("1824-1958",
                                      "1959-1972",
                                      "1973-present"))
table(bumbles.df$bin_3)
```

## Unique collector x date x species combinations
```{r}
bumbles.df <- bumbles.df %>%
  ungroup() %>%
  mutate(collector_spp_date = paste(collector,
                                    species,
                                    date,
                                    paste(dec_lat,
                                          dec_long,
                                          sep = ","),
                                    sep = ":"))
length(unique(bumbles.df$collector_spp_date))
```

## Save data for analysis 
```{r}
write_csv(bumbles.df,
          "./spatial_bumbles.csv")
```

# Rarefied species richness per bin
Per Bartomeus et al. (2013) PNAS paper.  Rarefy to 80% of number of specimens in smallest bin.  Smallest bin = 1963-1968 @ 2621 * 0.8 = *2097 specimens*

JK this is based on Richardson et al. (2018).  Using `iNEXT`.  

### 5 period estimated spp. richness
```{r}
rare.bumbles.5bin.df <- bumbles.df %>%
  distinct(collector_spp_date,
           .keep_all = TRUE) %>%
  dplyr::select(species, bin_5) %>%
  group_by(bin_5) %>%
  count(species)
rare.bumbles.5period.df <- data.frame(time_bin = rare.bumbles.5bin.df$bin_5,
                                      abun = rare.bumbles.5bin.df$n)
rare.bumbles.5period <- list("1" = sort(rare.bumbles.5period.df$abun[rare.bumbles.5period.df$time_bin == "1824-1937"]),
                             "2" = sort(rare.bumbles.5period.df$abun[rare.bumbles.5period.df$time_bin == "1937-1964"]),
                             "3" = sort(rare.bumbles.5period.df$abun[rare.bumbles.5period.df$time_bin == "1965-1972"]),
                             "4" = sort(rare.bumbles.5period.df$abun[rare.bumbles.5period.df$time_bin == "1973-2005"]),
                             "5" = sort(rare.bumbles.5period.df$abun[rare.bumbles.5period.df$time_bin == "2006-present"]))

rare.5period.df <- iNEXT(rare.bumbles.5period, 
             q = 0,
             datatype = "abundance",
             knots = 200,
             # endpoint = 25,000,
             nboot = 500)
ggiNEXT(rare.5period.df,
        color.var = "site")
rareest.5period.df <- estimateD(rare.bumbles.5period,
                                datatype = "abundance",
                                base = "coverage",
                                level = 0.985,
                                conf = 0.95)
rareest.5period.df$site <- as.numeric(as.character(rareest.5period.df$site))
rareest.5period.plot <- rareest.5period.df %>%
  filter(order == 0) %>%
  ggplot() + 
  geom_pointrange(mapping = aes(x = site, 
                                y = qD,
                                ymin = qD.LCL,
                                ymax = qD.UCL),
                  size = 0.8) +
  geom_smooth(mapping = aes(x = site,
                            y = qD),
              method = "lm",
              color = "black") + 
  theme_minimal()
rareest.5period.plot
```

### 8 period estimated spp. richness
```{r}
rare.bumbles.8bin.df <- bumbles.df %>%
  distinct(collector_spp_date,
           .keep_all = TRUE) %>%
  dplyr::select(species, bin_8) %>%
  group_by(bin_8) %>%
  count(species)
rare.bumbles.8period.df <- data.frame(time_bin = rare.bumbles.8bin.df$bin_8,
                                      abun = rare.bumbles.8bin.df$n)
rare.bumbles.8period <- list("1" = sort(rare.bumbles.8period.df$abun[rare.bumbles.8period.df$time_bin == "1824-1925"]),
                             "2" = sort(rare.bumbles.8period.df$abun[rare.bumbles.8period.df$time_bin == "1926-1950"]),
                             "3" = sort(rare.bumbles.8period.df$abun[rare.bumbles.8period.df$time_bin == "1951-1963"]),
                             "4" = sort(rare.bumbles.8period.df$abun[rare.bumbles.8period.df$time_bin == "1964-1969"]),
                             "5" = sort(rare.bumbles.8period.df$abun[rare.bumbles.8period.df$time_bin == "1970-1977"]),
                             "6" = sort(rare.bumbles.8period.df$abun[rare.bumbles.8period.df$time_bin == "1978-1996"]),
                             "7" = sort(rare.bumbles.8period.df$abun[rare.bumbles.8period.df$time_bin == "1997-2013"]),
                             "8" = sort(rare.bumbles.8period.df$abun[rare.bumbles.8period.df$time_bin == "2014-present"]))

rare.8period.df <- iNEXT(rare.bumbles.8period, 
             q = 0,
             datatype = "abundance",
             knots = 200,
             # endpoint = 25,000,
             nboot = 500)
ggiNEXT(rare.8period.df,
        color.var = "site")
rareest.8period.df <- estimateD(rare.bumbles.8period,
                                datatype = "abundance",
                                base = "coverage",
                                level = 0.985,
                                conf = 0.95)
rareest.8period.df$site <- as.numeric(as.character(rareest.8period.df$site))
rareest.8period.df <- rareest.8period.df %>%
  mutate(year = case_when(site == 1 ~ 1900,
                          site == 2 ~ 1926,
                          site == 3 ~ 1951,
                          site == 4 ~ 1964,
                          site == 5 ~ 1970,
                          site == 6 ~ 1978,
                          site == 7 ~ 1997,
                          site == 8 ~ 2014))
rareest.8period.plot <- rareest.8period.df %>%
  filter(order == 0) %>%
  mutate(year = case_when(site == 1 ~ 1900,
                          site == 2 ~ 1926,
                          site == 3 ~ 1951,
                          site == 4 ~ 1964,
                          site == 5 ~ 1970,
                          site == 6 ~ 1978,
                          site == 7 ~ 1997,
                          site == 8 ~ 2014)) %>%
  ggplot() + 
  geom_pointrange(mapping = aes(x = year, 
                                y = qD,
                                ymin = qD.LCL,
                                ymax = qD.UCL),
                  size = 0.8) +
  geom_smooth(mapping = aes(x = year,
                            y = qD),
              method = "lm",
              color = "black") + 
  ylab("Estimated species richness") + 
  xlab("Time Period") + 
  theme_classic()
rareest.8period.plot
ggsave("./model_plots/diversity_trends.eps",
       rareest.8period.plot,
       width = 5,
       height = 3)
rareest.8period.df
```

#### Permutation test
```{r}
perm.test <- function(data, n.perm) {
  temp.data <- data %>%
    filter(order == 0)
  true.lm <- lm(qD ~ year,
                data = temp.data)
  true.r2 <- summary(lm)$r.squared
  x <- seq(1, n.perm, 1)
  rsq <- list()
  order <- list()
  for (i in x) {
    rand.data.df <- data.frame(temp.data[sample(nrow(temp.data)),])
    rand.data.df$time <- seq.int(nrow(rand.data.df))
    lm <- lm(qD ~ time,
             data = rand.data.df)
    rsq[[i]] <- data.frame(summary(lm)$r.squared)
    order[[i]] <- data.frame(toString(c(rand.data.df$site)))
  }
  rsq.df <- bind_rows(rsq)
  colnames(rsq.df) <- "r2"
  order.df <- bind_rows(order)
  colnames(order.df) <- "site_order"
  permresults.df <- bind_cols(rsq.df, 
                              order.df)
  p.prop <- permresults.df %>%
    summarise(p.prop = sum(r2 > true.r2))
  p.value <- p.prop / nrow(permresults.df)
  assign("permtest.df",
         permresults.df,
         envir = .GlobalEnv)
  print(paste("p-value:",
              p.value))
}
perm.test(rareest.8period.df, n.perm = 1000)
perm.test(rareest.5period.df, n.perm = 1000)
```


# Average change in relative abundance
## Spatial patterns
### by **_county_** and 8 period average relative abundance change
```{r}
bumbles.relabun.bycty.df <- bumbles.df %>%
  distinct(collector_spp_date,
           .keep_all = TRUE) %>%
  dplyr::select(county, state, species, subgenus, bin_8) %>%
  group_by(county, state, species, subgenus, bin_8) %>%
  summarise(n_bumbles = n()) %>%
  mutate(state_name = abbr2state(state)) %>%
  ungroup()
bumbles.relabun.bycty.df
total.abun.bybin.df <- bumbles.relabun.bycty.df %>%
  group_by(bin_8, county) %>%
  summarise(total_bumbles = sum(n_bumbles))
total.abun.bybin.df
bumbles.relabun.bycty.df <- bumbles.relabun.bycty.df %>%
  left_join(total.abun.bybin.df,
            by = c("bin_8" = "bin_8", "county" = "county")) %>%
  mutate(relative_abun = n_bumbles / total_bumbles)

# Calculate change in relative abundance by county over time bins
bumbles.deltarelabun.bycty.df <- bumbles.relabun.bycty.df %>%
  ungroup() %>%
  group_by(county, state, species) %>%
  mutate(delta_ra = relative_abun - lag(relative_abun)) %>%
  summarise(mean_delta_ra = mean(delta_ra,
                                 na.rm = TRUE)) %>%
  mutate(state_full = abbr2state(state))
```

#### Save relative abundance data
```{r}
write_csv(bumbles.deltarelabun.bycty.df,
          "bumbles_deltarelabun.csv")
bumbles.relabun.bycty.df
```

#### Plot change in relative abundance on map
```{r}
bumbles.deltarelabun.bycty.df <-  full_join(ungroup(bumbles.deltarelabun.bycty.df),
                                            ungroup(us.county.midwest),
                                            by = c("county" = "CNTY_NAME"))
 

bumbles.deltarelabun.bycty.df <- bumbles.deltarelabun.bycty.df %>%
  mutate(inc_dec = case_when(mean_delta_ra < -0.05 ~ "Decrease",
                             between(mean_delta_ra, -0.025, 0.025) ~ "No change",
                             mean_delta_ra > 0.05 ~ "Increase"))
bumbles.deltarelabun.bycty.plot <- bumbles.deltarelabun.bycty.df %>%
  filter(!is.na(inc_dec)) %>%
  filter(!(species %in% c("Bombus fraternus",
                          "Bombus ashtoni"))) %>%
  ggplot() + 
  geom_polygon(mapping = aes(x = long,
                             y = lat,
                             fill = inc_dec,
                             group = group),
               alpha = 0.8) +             
  geom_polygon(data = us.county.midwest,
               mapping = aes(x = long,
                             y = lat,
                             group = group),
               fill = "transparent",
               color = "gray80",
               size = 0.25,
               na.rm = TRUE) + 
  scale_fill_manual(values = c("#C05746",
                               "#557F33",
                               "#CCF4AB")) +
  # scale_fill_distiller(type = "div",
  #                      palette = "RdYlBu",
  #                      na.value = "transparent") +
  coord_map("stereographic") +
  facet_wrap(~ species,
             labeller = as_labeller(species),
             ncol = 5) + 
  theme_void()
bumbles.deltarelabun.bycty.plot

bumbles.deltarelabun.bycty.hist <- bumbles.deltarelabun.df %>%
  mutate(inc_dec = case_when(mean_delta_ra < -0.05 ~ "Decrease",
                             between(mean_delta_ra, -0.025, 0.025) ~ "No change",
                             mean_delta_ra > 0.05 ~ "Increase")) %>%
  filter(!is.na(inc_dec)) %>%
  filter(!(species %in% c("Bombus fraternus",
                          "Bombus ashtoni"))) %>%
  group_by(species, inc_dec) %>%
  summarise(n = n()) %>%
  ggplot() + 
  # geom_vline(mapping = aes(xintercept = 0),
  #            color = "tomato",
  #            size = 0.5,
  #            alpha = 0.5) +
  # geom_density(mapping = aes(x = mean_delta_ra),
  #              adjust = 5,
  #              fill = "goldenrod",
  #              alpha = 0.5) + 
  geom_col(mapping = aes(x = inc_dec,
                         y = n,
                         fill = inc_dec)) + 
  scale_fill_manual(values = c("#C05746",
                               "#557F33",
                               "#CCF4AB")) +
  facet_wrap(~ species,
             labeller = as_labeller(species),
             ncol = 5) + 
  theme_minimal_hgrid()
bumbles.deltarelabun.bycty.hist
```

### by **_county_** and 2 period relative abundance change
```{r}
bumbles.relabun.bycty.2per.df <- bumbles.df %>%
  dplyr::select(county, state, species, subgenus, t_period) %>%
  group_by(county, state, species, subgenus, t_period) %>%
  summarise(n_bumbles = n()) %>%
  mutate(state_name = abbr2state(state)) %>%
  ungroup()
bumbles.relabun.bycty.2per.df
total.abun.bybin.2per.df <- bumbles.relabun.bycty.2per.df %>%
  group_by(t_period, county, state) %>%
  summarise(total_bumbles = sum(n_bumbles))
total.abun.bybin.2per.df
bumbles.relabun.bycty.2per.df <- bumbles.relabun.bycty.2per.df %>%
  left_join(total.abun.bybin.2per.df,
            by = c("t_period" = "t_period", 
                   "county" = "county", 
                   "state" = "state")) %>%
  mutate(relative_abun = n_bumbles / total_bumbles)
bumbles.relabun.bycty.2per.df

bumbles.relabun.bycty.2per.df$t_period <- factor(bumbles.relabun.bycty.2per.df$t_period,
                                                 levels = c("historical",
                                                            "contemp"))
bumbles.relabun.bycty.2per.df
bumbles.deltarelabun.bycty.2per.df <- bumbles.relabun.bycty.2per.df %>%
  ungroup() %>%
  group_by(county, state, species) %>%
  mutate(delta_ra = relative_abun - lead(relative_abun)) %>%
  mutate(state_full = abbr2state(state))
bumbles.deltarelabun.bycty.2per.df
bumbles.deltarelabun.bycty.2per.df <-  full_join(ungroup(bumbles.deltarelabun.bycty.2per.df),
                                                 ungroup(us.county.midwest),
                                                 by = c("county" = "CNTY_NAME"))

bumbles.deltarelabun.bycty.2per.plot <- ggplot() + 
  geom_polygon(data = bumbles.deltarelabun.bycty.2per.df,
               mapping = aes(x = long,
                             y = lat,
                             fill = delta_ra,
                             group = group)) +
  geom_polygon(data = us.county.midwest,
               mapping = aes(x = long,
                             y = lat,
                             group = group),
               fill = "transparent",
               color = "gray80",
               size = 0.25,
               na.rm = TRUE) + 
  scale_fill_distiller(type = "div",
                       palette = "RdYlBu",
                       na.value = "gray80") +
  coord_map("stereographic") +
  facet_wrap(~ species,
             labeller = as_labeller(species),
             ncol = 5) + 
  theme_void()
bumbles.deltarelabun.bycty.2per.plot
```

### by **_state_**
```{r}
bumbles.relabun.bystate.df <- bumbles.df %>%
  distinct(collector_spp_date,
           .keep_all = TRUE) %>%
  dplyr::select(state, species, subgenus, bin_5) %>%
  group_by(state, species, subgenus, bin_5) %>%
  summarise(n_bumbles = n()) %>%
  mutate(state_name = abbr2state(state)) %>%
  ungroup()
bumbles.relabun.bystate.df
total.abun.bybin.df <- bumbles.relabun.bystate.df %>%
  group_by(bin_5, state) %>%
  summarise(total_bumbles = sum(n_bumbles))
total.abun.bybin.df
bumbles.relabun.bystate.df <- bumbles.relabun.bystate.df %>%
  left_join(total.abun.bybin.df,
            by = c("bin_5" = "bin_5", "state" = "state")) %>%
  mutate(relative_abun = n_bumbles / total_bumbles)
bumbles.relabun.bystate.df %>%
  ungroup() %>%
  group_by(species, state) %>%
  mutate(delta_ra = c(NA, diff(relative_abun)))
```

### by **_time bin only_**
```{r}
bumbles.relabun.df <- bumbles.df %>%
  distinct(collector_spp_date,
           .keep_all = TRUE) %>%
  dplyr::select(state, species, subgenus, bin_5,) %>%
  group_by(species, subgenus, bin_5) %>%
  summarise(n_bumbles = n()) %>%
  ungroup()
bumbles.relabun.df
total.abun.bybin.df <- bumbles.relabun.df %>%
  group_by(bin_5) %>% 
  summarise(total_bumbles = sum(n_bumbles))
total.abun.bybin.df
bumbles.relabun.df <- bumbles.relabun.df %>%
  left_join(total.abun.bybin.df,
            by = "bin_5") %>%
  mutate(relative_abun = n_bumbles / total_bumbles)
bumbles.relabun.df <- bumbles.relabun.df %>%
  group_by(species) %>%
  mutate(time_period_num = row_number())
bumbles.relabun.df
```

## Create area plot to show temporal trends
```{r}
bumble.area.plot <- bumbles.relabun.df %>%
  group_by(time_period_num) %>%
  arrange(relative_abun, 
          .by_group = TRUE) %>%
  mutate(species_factor = factor(species, 
                                 levels = c(.$species[.$time_period_num == 3]))) %>%
  ggplot() + 
  geom_area(mapping = aes(x = time_period_num,
                          y = relative_abun,
                          fill = species_factor),
            position = position_stack(reverse = FALSE)) + 
  scale_fill_viridis_d(option = "inferno",
                       direction = 1) +
  facet_wrap(~ subgenus) + 
  theme_minimal()
bumble.area.plot
ggsave("./model_plots/bumble_area_plot.eps",
       bumble.area.plot,
       width = 7,
       height = 4)
```


## Plot each: 
### by **_time only_**
```{r}
bumbles.relabun.df %>%
  ggplot(mapping = aes(label = species)) + 
  # geom_line(mapping = aes(x = bin,
  #                         y = relative_abun,
  #                         color = species,
  #                         group = species),
  #           # color = "#EEC643",
  #           size = 1.25) +
  geom_point(mapping = aes(x = bin_5,
                           y = relative_abun,
                           color = species),
             size = 3) + 
             # col = "#EEC643",
             # alpha = 0.75) + 
  # geom_text(mapping = aes(x = t_period,
  #                         y = relative_abun + 0.1),
  #           color = "black") + 
  # geom_dl(mapping = aes(x = t_period,
  #                       y = relative_abun,
  #                       label = species),
  #         method = "last.points",
  #         color = "black") + 
  geom_smooth(mapping = aes(x = bin_5,
                            y = relative_abun,
                            group = species,
                            color = species),
              method = "lm",
              linetype = 1,
              alpha = 0.1) +
  # scale_color_gradient(low = "#382B01",
  #                      high = "#F4E3A7") + 
  theme_minimal() + 
  scale_y_continuous(limits = c(-0.05, 0.5)) + 
  scale_x_discrete(expand = c(0.01, 0.5)) + 
  # coord_fixed(ratio = 2) + 
  facet_grid(vars(subgenus))
```

### by **_state only_**
```{r}
bumbles.relabun.bystate.df %>%
  ggplot(mapping = aes(label = species)) + 
  # geom_line(mapping = aes(x = bin,
  #                         y = relative_abun,
  #                         color = species,
  #                         group = species),
  #           # color = "#EEC643",
  #           size = 1.25) +
  geom_point(mapping = aes(x = bin_5,
                           y = relative_abun,
                           color = species),
             size = 3) + 
             # col = "#EEC643",
             # alpha = 0.75) + 
  # geom_text(mapping = aes(x = t_period,
  #                         y = relative_abun + 0.1),
  #           color = "black") + 
  # geom_dl(mapping = aes(x = t_period,
  #                       y = relative_abun,
  #                       label = species),
  #         method = "last.points",
  #         color = "black") + 
  geom_smooth(mapping = aes(x = bin_5,
                            y = relative_abun,
                            group = species,
                            color = species),
              method = "lm",
              linetype = 1,
              alpha = 0.1) +
  # scale_color_gradient(low = "#382B01",
  #                      high = "#F4E3A7") + 
  theme_light() + 
  scale_y_continuous(limits = c(-0.05, 0.75)) + 
  scale_x_discrete(expand = c(0.01, 0.5)) + 
  # coord_fixed(ratio = 2) + 
  facet_grid(vars(subgenus))
```

### by **_county_**
```{r}
bumbles.relabun.bycty.df %>%
  ggplot(mapping = aes(label = species)) + 
  # geom_line(mapping = aes(x = bin,
  #                         y = relative_abun,
  #                         color = species,
  #                         group = species),
  #           # color = "#EEC643",
  #           size = 1.25) +
  geom_point(mapping = aes(x = bin_8,
                           y = relative_abun,
                           color = species),
             size = 3) + 
             # col = "#EEC643",
             # alpha = 0.75) + 
  # geom_text(mapping = aes(x = t_period,
  #                         y = relative_abun + 0.1),
  #           color = "black") + 
  # geom_dl(mapping = aes(x = t_period,
  #                       y = relative_abun,
  #                       label = species),
  #         method = "last.points",
  #         color = "black") + 
  geom_smooth(mapping = aes(x = bin_8,
                            y = relative_abun,
                            group = species,
                            color = species),
              method = "lm",
              linetype = 1,
              alpha = 0.1) +
  # scale_color_gradient(low = "#382B01",
  #                      high = "#F4E3A7") + 
  theme_light() + 
  scale_y_continuous(limits = c(-0.05, 1.0)) + 
  scale_x_discrete(expand = c(0.01, 0.5)) + 
  # coord_fixed(ratio = 2) + 
  facet_grid(vars(subgenus))
```

# Relate change in ag with change in relative abundance
## Read in data
```{r}
bumbles.deltarelabun.df <- read_csv("./bumbles_deltarelabun.csv")
bumbles.species.subgenus.df <- bumbles.df %>%
  group_by(species, subgenus) %>%
  distinct(species)
bumbles.deltarelabun.df <- bumbles.deltarelabun.df %>%
  left_join(bumbles.species.subgenus.df,
            by = "species")
midwestag.df <- read_csv("./midwestag.csv")
```

## Combine data
```{r}
bumble.by.ag.df <- midwestag.df %>%
  dplyr::select(STATE_NAME, 
                CNTY_NAME, 
                SUB_REGION, 
                ag_stat_name, 
                ag_stat_value, 
                year, 
                stat, 
                ag_delta) %>%
  group_by(STATE_NAME, CNTY_NAME, stat) %>%
  summarise(mean_ag_delta = mean(ag_delta,
                                 na.rm = TRUE)) %>%
  left_join(bumbles.deltarelabun.df,
            by = c("CNTY_NAME" = "county", 
                   "STATE_NAME" = "state_full"))
```

## Plot `delta_ag` vs `delta_relabun` by species w/overall average
```{r}
bumble.by.ag.plot <- bumble.by.ag.df %>%
  filter(stat == "RATIO") %>%
  filter(!is.na(mean_delta_ra)) %>%
  ggplot() + 
  geom_vline(xintercept = 0.0,
             color = "black",
             size = 0.75,
             alpha = 0.25) +
  geom_hline(yintercept = 0.0,
             color = "black",
             size = 0.75,
             alpha = 0.25) +
  geom_point(mapping = aes(x = mean_ag_delta,
                           y = mean_delta_ra,
                           fill = species),
             shape = 21,
             color = "black") + 
  geom_smooth(mapping = aes(x = mean_ag_delta,
                            y = mean_delta_ra,
                            group = species,
                            color = species),
              method = "lm",
              se = FALSE) + 
  # geom_smooth(mapping = aes(x = mean_ag_delta,
  #                           y = mean_delta_ra),
  #             method = "lm",
  #             color = "red",
  #             size = 1.5) + 
  xlim(-0.025, 0.075) + 
  ylim(-1, 1) +
  xlab("Mean change in county-level proportion ag") + 
  ylab("Mean change in relative abundance") +
  scale_fill_viridis_d(option = "inferno",
                       direction = 1) +
  scale_color_viridis_d(option = "inferno",
                        direction = 1) + 
  facet_wrap(~ subgenus,
             ncol = 4) +
  theme_minimal() + 
  theme(legend.position = "none") + 
  theme(panel.border = element_rect(color = "gray50",
                                    size = 1.25,
                                    fill = "transparent"))

bumble.by.ag.plot <- direct.label(bumble.by.ag.plot, 
                                  list("extreme.grid",
                                       cex = 0.5))
bumble.by.ag.plot
ggsave("./bumble_byag_plot.png",
       bumble.by.ag.plot,
       height = 4.5,
       width = 7)

```

## Density plot of county-level average ag change for each state
```{r}
ggplot() + 
  geom_vline(xintercept = 0.0,
             color = "red",
             size = 1.5,
             alpha = 0.5) + 
  geom_density(data = bumble.by.ag.df %>%
                 filter(stat == "RATIO") %>%
                 filter(!is.na(mean_delta_ra)),
               mapping = aes(x = mean_ag_delta,
                             fill = state),
               alpha = 0.75) + 
  scale_fill_viridis_d(option = "inferno",
                       direction = 1) + 
  theme_minimal()
```

## Plot ag ratio vs `delta_relabun` by species w/overall average
```{r}
bumble.by.agratio.plot <- midwestag.df %>%
  dplyr::select(STATE_NAME, 
                CNTY_NAME, 
                SUB_REGION, 
                ag_stat_name, 
                ag_stat_value, 
                year, 
                stat, 
                ag_delta) %>%
  filter(stat == "RATIO") %>%
  group_by(STATE_NAME, CNTY_NAME) %>%
  summarise(mean_ag = mean(ag_stat_value,
                           na.rm = TRUE)) %>%
  left_join(bumbles.deltarelabun.df,
            by = c("CNTY_NAME" = "county", 
                   "STATE_NAME" = "state_full")) %>%
  filter(!is.na(mean_delta_ra)) %>%
  ggplot() + 
  geom_hline(yintercept = 0,
             color = "black",
             alpha = 0.25) + 
  geom_point(mapping = aes(x = mean_ag,
                           y = mean_delta_ra,
                           fill = species),
             shape = 21,
             color = "black") + 
  geom_smooth(mapping = aes(x = mean_ag,
                            y = mean_delta_ra,
                            group = species,
                            color = species),
              method = "lm",
              se = FALSE) + 
  # geom_smooth(mapping = aes(x = mean_ag,
  #                           y = mean_delta_ra),
  #             method = "lm",
  #             color = "red",
  #             size = 1.5) + 
  xlim(0, 1) + 
  ylim(-1, 1) +
  xlab("Mean county-level proportion ag") + 
  ylab("Mean change in relative abundance") +
  scale_fill_viridis_d(option = "inferno",
                       direction = 1) +
  scale_color_viridis_d(option = "inferno",
                        direction = 1) + 
  facet_wrap(~ subgenus,
             ncol = 4) +
  theme_minimal() + 
  theme(legend.position = "none") + 
  theme(panel.border = element_rect(color = "gray50",
                                    size = 1.25,
                                    fill = "transparent"))

bumble.by.agratio.plot <- direct.label(bumble.by.agratio.plot, 
                                       list("smart.grid",
                                       cex = 0.5))
bumble.by.agratio.plot
ggsave("./bumble_byagratio_plot.png",
       bumble.by.agratio.plot,
       height = 4.5,
       width = 7)
```

# Change in range 
## hist vs. contem
### Gather data
```{r}
bumbles.df %>%
  distinct(collector_spp_date,
           .keep_all = TRUE) %>%
  dplyr::select(species, state, county, decade, t_period, subgenus, bin_3, bin_5, bin_8) %>%
  ungroup() %>%
  group_by(species, t_period, county, state, subgenus) %>%
  distinct(county, 
           .keep_all = TRUE) %>%
  filter(t_period == "historical") %>%
  ungroup() %>%
  group_by(species) %>%
  summarise(n_hist_counties = n()) %>%
  left_join(bumbles.df %>%
              distinct(collector_spp_date,
                       .keep_all = TRUE) %>%
              dplyr::select(species, state, county, decade, t_period, subgenus, bin_3, bin_5, bin_8) %>%
              ungroup() %>%
              group_by(species, t_period, county, state, subgenus) %>%
              distinct(county,
                       .keep_all = TRUE) %>%
              filter(t_period == "contemp") %>%
              ungroup() %>%
              group_by(species) %>%
              summarise(n_contemp_counties = n()),
            by = "species") %>%
  mutate(n_contemp_counties = replace_na(n_contemp_counties, 0)) %>%
  mutate(delta_range = ((n_contemp_counties - n_hist_counties) / n_hist_counties) * 100) %>%
  mutate(inc_dec = ifelse(delta_range >= 0,
                          "increase",
                          "decrease"))
bumble.range.df
```

### Plot percent change in range
```{r}
bumble.range.df %>%
  arrange(desc(delta_range)) %>%
  mutate(delta_range = round(delta_range, 
                             digits = 2)) %>%
  mutate(row_order = factor(species, 
                            levels = species)) %>%
  ggplot(mapping = aes(x = row_order,
                       y = delta_range,
                       label = delta_range,
                       fill = inc_dec)) + 
  geom_segment(mapping = aes(y = 0,
                             x = row_order,
                             yend = delta_range,
                             xend = row_order,
                             color = inc_dec),
               size = 0.5,
               color = "black") + 
  geom_point(size = 8,
             stat = "identity",
             shape = 21,
             color = "black") + 
  geom_text(color = "black",
            size = 2) + 
  scale_fill_manual(values = c("#C05746",
                                "#557F33")) + 
  scale_color_manual(values = c("#C05746",
                                "#557F33")) + 
  labs(title = "Change in bumble bee county occupancy",
       subtitle = "Occupied Counties: Contemporary / Historical") +
  ylab("Percent change") + 
  xlab("Species") + 
  coord_flip() + 
  theme_minimal_vgrid() + 
  theme(legend.position = "None")
```

## Change in range: avg. by period
### Gather data
```{r}
bumble.range.byperiod.df <- bumbles.df %>%
  distinct(collector_spp_date,
           .keep_all = TRUE) %>%
  dplyr::select(species, state, county, decade, t_period, subgenus, bin_3, bin_5, bin_8) %>%
  ungroup() %>%
  group_by(species, bin_8, county, state, subgenus) %>%
  distinct(county) %>%
  ungroup() %>%
  group_by(subgenus, species, bin_8) %>%
  summarise(n_counties = n()) %>%
  mutate(delta = ((n_counties - lag(n_counties)) / lag(n_counties)) * 100)
bumble.range.byperiod.df
```

### Plot temporal trend
```{r}
bumble.range.byperiod.df %>%
  ggplot() + 
  geom_point(mapping = aes(x = bin_8,
                           y = n_counties,
                           fill = species),
             shape = 21,
             color = "black") + 
  geom_line(mapping = aes(x = bin_8,
                          y = n_counties,
                          group = species,
                          color = species)) + 
  facet_wrap(~ species,
             ncol = 4) + 
  theme_minimal_hgrid() + 
  ylab("Number of counties") +
  xlab("Time period") +
  theme(axis.text.x = element_text(angle = 45,
                                   size = 7.5,
                                   hjust = 1),
        axis.text.y = element_text(size = 8),
        strip.text.x = element_text(size = 10)) + 
  theme(legend.position = "None")
```

### Plot average percent change
Probably not the best metric - tells a different story than the overall trend.
```{r}
bumble.range.byperiod.df
bumble.range.byperiod.df %>%
  group_by(species) %>%
  summarise(mean_delta = round(mean(delta,
                              na.rm = TRUE), 2)) %>%
  mutate(inc_dec = ifelse(mean_delta >= 0,
                          "increase",
                          "decrease")) %>%
  arrange(desc(mean_delta)) %>%
  mutate(row_order = factor(species,
                            levels = species)) %>%
  ggplot(mapping = aes(x = row_order,
                       y = mean_delta,
                       label = mean_delta,
                       fill = inc_dec)) + 
  geom_segment(mapping = aes(y = 0,
                             x = row_order,
                             yend = mean_delta,
                             xend = row_order,
                             color = inc_dec),
               size = 0.5,
               color = "black") + 
  geom_point(size = 8,
             stat = "identity",
             shape = 21,
             color = "black") + 
  geom_text(color = "black",
            size = 2) + 
  scale_fill_manual(values = c("#C05746",
                                "#557F33")) + 
  scale_color_manual(values = c("#C05746",
                                "#557F33")) + 
  labs(title = "Average change in bumble bee ranges",
       subtitle = "Average change in county occupancy over time periods") +
  ylab("Percent change") + 
  xlab("Species") + 
  coord_flip() + 
  theme_minimal_vgrid() + 
  theme(legend.position = "None")
```

## Visualize geographic shifts
### Gather data
```{r}
bumble.georange.df <- bumbles.df %>%
  dplyr::select(species, state, county, decade, t_period, subgenus, bin_3, bin_5, bin_8) %>%
  ungroup() %>%
  group_by(species, state, county, subgenus, bin_8) %>%
  distinct(county) %>%
  ungroup() %>%
  mutate(state_full = abbr2state(state)) %>%
  full_join(ungroup(us.county.midwest),
            by = c("county" = "CNTY_NAME",
                   "state_full" = "region"))
bumble.georange.df
```

### Plot geographic trend
```{r}
bumble.georange.df %>%
  filter(!is.na(species)) %>%
  ggplot() + 
  geom_polygon(mapping = aes(x = long,
                             y = lat,
                             group = group),
               alpha = 0.8,
               fill = "tomato") +             
  geom_polygon(data = us.county.midwest,
               mapping = aes(x = long,
                             y = lat,
                             group = group),
               fill = "transparent",
               color = "gray80",
               size = 0.1,
               na.rm = TRUE) + 
  coord_map("stereographic") +
  facet_grid(species ~ bin_8) + 
  theme_void()
  # ggsave("range_by_time.png")
bumble.georange.df
```

