---
title: "Ch4 | Historical Ag & Bumble Bee Abundance/Community Changes"
subtitle: "Historical ag census data cleanup & prep"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_notebook
---

**Name:** Jeremy Hemberger
**Email:** j.hemberger.wisc@gmail.com
**Institution:** University of Wisconsin - Madison | Department of Entomology

# Import libraries
```{r}
library(tidyverse)
library(maptools)
library(maps)
library(raster)
library(ggmap)
library(gridExtra)
library(gganimate)
library(transformr)
```

# Load in Mike's proportion ag data
```{r}
histag2.df <- read_tsv("./AgCensus_MasterDataFrame.txt")
```

## Create crop code data frame
```{r}
cropcode.df <- tibble(crop_abbr = c("Brl",
                                    "Bkw",
                                    "Crn",
                                    "Ctn",
                                    "Flx",
                                    "Hay",
                                    "Oat",
                                    "Pnt",
                                    "Ptt",
                                    "Pls",
                                    "Ric",
                                    "Rye",
                                    "Sgm",
                                    "Soy",
                                    "Swt",
                                    "Sgc",
                                    "Tbc",
                                    "Wht",
                                    "Cat",
                                    "Hrs",
                                    "Hmn",
                                    "Shp",
                                    "Swn"),
                      crop_name = c("Barley",
                                    "Buckwheat",
                                    "Corn",
                                    "Cotton",
                                    "Flax",
                                    "Hay (Grass + Legume)",
                                    "Oats",
                                    "Peanuts",
                                    "Potato",
                                    "Pulses (Bean, pea, lentil)",
                                    "Rice",
                                    "Rye",
                                    "Sorghum",
                                    "Soybeans",
                                    "Sweet Potato",
                                    "Sugar Cane",
                                    "Tobacco",
                                    "Wheat",
                                    "Cattle",
                                    "Horse",
                                    "Human",
                                    "Sheep",
                                    "Swine"))
```


## Reshape from wide -> long form
```{r}
histag2.df <- histag2.df %>%
  gather(key = "crop_year",
         value = "prop_county",
         -c(STATE, COUNTY, FIPS, STCTY, AREA_KM, Bailey_Eco, USDA_FRR, Lon, Lat)) %>%
  separate(crop_year, 
           sep = 3,
           remove = FALSE,
           into = c("crop", "year")) %>%
  left_join(cropcode.df,
            by = c("crop" = "crop_abbr"))
histag2.df <- histag2.df %>%
  filter(!crop %in% c("Cat", "Hrs", "Hmn", "Shp", "Swn"))
histag2.df$year <- as.numeric(histag2.df$year)
histag2.df
```

## Trim down dataset to upper midwest
```{r}
midwestag.bycrop.df <- histag2.df %>%
  filter(STATE %in% c("IL", "IN", "IA", "MI", "MN", "WI"))
midwestag.bycrop.df
```

# Calculate ag predictors (Mike's data)
## Crop richness
```{r}
midwestag.richness.df <- midwestag.bycrop.df %>%
  filter(prop_county != 0) %>%
  group_by(STATE, COUNTY, year) %>%
  summarise(n_crops = n())
midwestag.richness.df
```
```{r}

```

## Crop evenness (Simpson's E)
```{r}
midwestag.evenness.df <- midwestag.bycrop.df %>%
  #filter(prop_county >= 0.00001) %>%
  mutate(prop_count_rnd = round(prop_county, 
                                digits = 8)) %>%
  group_by(STATE, COUNTY, year) %>%
  summarise(numerator = round(-sum((prop_county * log(prop_county)),
                                  na.rm = TRUE),
                              digits = 3)) %>%
  left_join(midwestag.richness.df,
            by = c("STATE" = "STATE", 
                   "COUNTY" = "COUNTY", 
                   "year" = "year")) %>%
  mutate(crop_evenness = numerator / log(n_crops)) %>%
  filter(crop_evenness != Inf)
midwestag.evenness.df
```
```{r}
midwestag.evenness.df %>%
  filter(between(crop_evenness, 0, 1)) %>%
ggplot() + 
  # geom_point(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  # geom_smooth(mapping = aes(x = year, 
  #                          y = n_crops,
  #                          color = STATE)) + 
  geom_point(mapping = aes(x = year, 
                           y = crop_evenness,
                           color = STATE)) + 
  geom_smooth(mapping = aes(x = year, 
                           y = crop_evenness,
                           color = STATE),
              method = "lm") + 
  theme_minimal()
```

## Crop coverage (proportion of county)
```{r}
midwestag.cropprop.df <- midwestag.bycrop.df %>%
  group_by(STATE, COUNTY, year) %>%
  summarise(prop_cropland = sum(prop_county))
midwestag.cropprop.df
```

## Combine data
```{r}
midwestag.vars.df <- midwestag.evenness.df %>%
  left_join(midwestag.cropprop.df,
            by = c("STATE" = "STATE", 
                   "COUNTY" = "COUNTY", 
                   "year" = "year")) %>%
  separate(COUNTY,
           sep = -7,
           into = "county") %>%
  mutate(state = STATE) %>%
  dplyr::select(state, everything()) %>%
  ungroup() %>%
  dplyr::select(-STATE)
midwestag.vars.df

write_csv(midwestag.vars.df,
          "./midwestag_vars.csv")
```

# Clean up ag census data
## Load in raw data
```{r}
histag <- read_csv("./2018_HistoricalAg_Pop.csv",
                   col_names = TRUE,
                   na = "NA")
```

## Split into ag-only data
```{r}
histag.ag <- histag %>%
  dplyr::select(-contains("POP")) %>%
  gather(key = ag_stat_name,
         value = ag_stat_value,
         contains("IFC"))
```

## Split into pop-only data
```{r}
histag.pop <- histag %>%
  dplyr::select(-contains("IFC")) %>%
  gather(key = pop_period,
         value = pop,
         contains("POP"))
```

## Parse out date, ag statistics from histag.ag
```{r}
histag.ag <- histag.ag %>%
  mutate(year = str_extract(ag_stat_name, "[:digit:]{4}"),
         stat = str_extract(ag_stat_name, "(?<=[:digit:]{4})[:alnum:]+"))
histag.ag$stat[histag.ag$stat == "R"] <- "RATIO"
```

## Save HistAg data
```{r}
write_csv(histag.ag,
          "./histag_clean.csv")
```


Quick plot of temporal trends

```{r}
us.county.50 <- read_csv("./counties.csv")
us.county.48 <- us.county.50 %>%
  filter(region != "alaska" & region != "hawaii")
rm(us.county.50)
us.county.48$region <- str_to_title(us.county.48$region)
us.county.48$subregion <- str_to_title(us.county.48$subregion)
names(us.county.48)[names(us.county.48) == 'subregion'] <- 'CNTY_NAME'

histag.plot.df <- left_join(us.county.48, 
                            histag.ag,
                            by = "CNTY_NAME")

base.us.state <- ggplot(data = us.county.48, 
                        mapping = aes(x = long,
                                      y = lat, 
                                      group = group)) + 
  coord_map("stereographic") + 
  geom_polygon(fill = "transparent",
               color = "gray80",
               size = 0.25) + 
  theme_minimal()
base.us.state

# histag.plot.df <- histag.plot.df %>%
  # filter(stat == "M2")

# ag.county <- base.us.state + 
  # geom_polygon(data = histag.plot.df, aes(fill = ag_stat_value))

# ag.county + facet_grid(rows = vars(year))
```

For loop plot of all ag maps
```{r}
ag.plots <- function() {
  years <- unique(histag.plot.df$year)
  plot.ls <- list()
  for (i in years) {
      plot.df <- histag.plot.df %>%
        filter(stat == "RATIO") %>%
        filter(year == i)
      plot <- base.us.state + 
        scale_fill_distiller(palette = "Oranges",
                             direction = 1,
                             limits = c(0,1),
                             na.value = "transparent",
                             name = "Cropland:County Area") + 
        geom_polygon(data = plot.df,
                     mapping = aes(fill = ag_stat_value)) + 
        labs(title = "Cropland : Total County Area",
             subtitle = i) + 
        theme(plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(hjust = 0.5))
      plot.ls[[i]] <- plot
  }
  assign("ag.plots",
         plot.ls,
         envir = .GlobalEnv)
}
ag.plots()
```

Export all `ag.plots` to image, combine externally to gif (due to gganimate memory restrictions)

```{r}
export.plots <- function() {
  for (i in 1:length(ag.plots)) {
  ggsave(filename = paste("plot", 
                          names(ag.plots[i]), 
                          ".png", 
                          sep = ""),
         plot = ag.plots[[i]])
    }
}
export.plots()
```


Proportion of Dane county 
```{r}
histag.df %>%
  filter(CNTY_NAME == "Columbia" & STATE_NAME == "Wisconsin" & stat == "RATIO") %>%
  ggplot() + 
  geom_col(mapping = aes(x = year,
                         y = ag_stat_value)) +
  theme_minimal()
```

# Agriculture in Midwest
## Split data
```{r}
str(histag.df)

midwestag.df <- histag.df %>%
  filter(STATE_NAME %in% c("Wisconsin",
                      "Michigan",
                      "Iowa",
                      "Illinois",
                      "Indiana",
                      "Minnesota")) 
str(midwestag.df)
str(us.county.midwest)
```

## Plot ag ratio over time
```{r}
midwestag.plot.df <- midwestag.df %>%
  dplyr::select(STATE_NAME, CNTY_NAME, ag_stat_name, ag_stat_value, year) %>%
  left_join(us.county.midwest,
            by = c("CNTY_NAME" = "CNTY_NAME"))

midwestag.plot <- ggplot() +
  geom_polygon(data = midwestag.plot.df,
               mapping = aes(x = long,
                             y = lat,
                             group = group,
                             fill = ag_stat_value),
               color = "gray80",
               size = 0.25,
               na.rm = TRUE) + 
  scale_fill_distiller(palette = "Oranges",
                       direction = 1,
                       limits = c(0,1),
                       na.value = "transparent",
                       name = "Cropland:County Area") + 
  coord_map("stereographic") + 
  labs(title = "Cropland : Total County Area") + 
  facet_wrap(~ year,
             ncol = 5) +
  theme_void()
midwestag.plot
```

# Calculate change in ag over time
## Demo w/1 county
```{r}
midwestag.df %>%
  filter(CNTY_NAME == "Columbia" & STATE_NAME == "Wisconsin" & stat == "RATIO") %>%
  group_by(STATE_NAME, CNTY_NAME, stat) %>%
  arrange(STATE_NAME, CNTY_NAME, year) %>%
  filter(stat == "RATIO") %>%
  mutate(ag_delta = ag_stat_value - lag(ag_stat_value)) %>%
  summarise(mean_ag_delta = mean(ag_delta,
                                 na.rm = TRUE)) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = mean_ag_delta)) +
  theme_minimal()
# midwestag.df
# write_csv(midwestag.df,
#           "./midwestag.csv")
```

# Yields of corn over time
```{r}
agyields.df <- read_csv("./agyields_historic.csv")
agyields.df
```

## Plot yield over time
```{r}
agyields.df %>%
  filter(!is.na(`yield/acre`)) %>%
  ggplot() + 
  geom_point(mapping = aes(x = year,
                           y = `yield/acre`)) + 
  geom_smooth(mapping = aes(x = year,
                           y = `yield/acre`,
                           color = state),
              se = FALSE) + 
  geom_smooth(mapping = aes(x = year,
                            y = `yield/acre`),
              color = "red",
              size = 2,
              se = FALSE) +
  theme_classic()
```


